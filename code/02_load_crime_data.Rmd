---
title: "Process city-specific data"
output: html_notebook
---


The code in this file loads crime data from different cities in whatever format
is provided, and converts it into a common format that can be joined together.
Once processed, data from each city are saved to a temporary file to minimise
memory usage. Temporary files are in .Rds format because it is likely to be
[smaller than a zipped CSV](https://csgillespie.github.io/efficientR/efficient-inputoutput.html#efficient-data-export-.rdata-or-.rds).


# Cities included

The initial exploratory analysis identified these cities as having published 
geocoded data with reasonable crime categories since at least January 2013 
(giving four years of data as of December 2016):

 * Chicago
 * Detroit
 * Fort Worth
 * Los Angeles
 * Louisville
 * New York City
 * San Francisco
 * Seattle
 * Tucson
 * Virginia Beach

Note: 

 * Boston is ommitted because the offence categories used are in many cases 
   (e.g. fraud, larceny) too broad to be mapped to NIBRS
 * Kansas City, MO, is not on the list because some crimes are geocoded to 
   places outside the city boundary and it's not obvious what the reason is
 * Minneapolis is not on the list because there is no field from which NIBRS 
   categories can be generated
 * New Orleans is ommitted because some offences are spread across (many) 
   multiple records
 * Raleigh is not on the list because lots of offences (including all those 
   committed by juveniles) are ommitted
   

# Chicago

```{r}
read_csv('../original_data/Chicago 2001 to date.csv') %>% 
  rename(Address = Block) %>% 
  # add date variable
  add_date_var("Date", "mdY T", "America/Chicago") %>% 
  # filter by year
  filter_by_year(yearFirst, yearLast) %>% 
  # add crime categories
  left_join(read_csv("../crime_categories/categories_Chicago.csv"), 
            by = c("Primary Type", "Description")) %>% 
  # separate burglaries and robberies into sub-categories
  mutate(NIBRS_Offense_Type = case_when(
    # residential burglary
    # CONSIDER ADDING "HOTEL/MOTEL", "RESIDENTIAL YARD (FRONT/BACK)", 
    # "BOAT/WATERCRAFT", "DRIVEWAY - RESIDENTIAL"
    NIBRS_Offense_Code == "220" & `Location Description` %in% c("RESIDENCE", 
      "APARTMENT", "RESIDENCE-GARAGE", "CHA APARTMENT", 
      "RESIDENCE PORCH/HALLWAY", "NURSING HOME/RETIREMENT HOME", 
      "COLLEGE/UNIVERSITY RESIDENCE HALL") ~ 
      "22A Domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "120" & `Location Description` %in% 
      c("SMALL RETAIL STORE", "GAS STATION", "RESTAURANT", 
        "GROCERY FOOD STORE", "BANK", "CONVENIENCE STORE", "DEPARTMENT STORE", 
        "DRUG STORE", "TAVERN/LIQUOR STORE", "BARBERSHOP", "CURRENCY EXCHANGE", 
        "CLEANING STORE", "BAR OR TAVERN", "COMMERCIAL / BUSINESS OFFICE", 
        "CAR WASH", "VEHICLE-COMMERCIAL", "CONSTRUCTION SITE", 
        "POLICE FACILITY/VEH PARKING LOT", "CHURCH/SYNAGOGUE/PLACE OF WORSHIP", 
        "WAREHOUSE", "DELIVERY TRUCK", "FACTORY/MANUFACTURING BUILDING", 
        "GOVERNMENT BUILDING/PROPERTY", "APPLIANCE STORE", 
        "MEDICAL/DENTAL OFFICE", "MOVIE HOUSE/THEATER", "PAWN SHOP", 
        "SAVINGS AND LOAN", "NEWSSTAND", "POOL ROOM", 
        "AIRPORT BUILDING NON-TERMINAL - NON-SECURE AREA", "CREDIT UNION", 
        "BOWLING ALLEY", "VEHICLE - DELIVERY TRUCK") ~ "12B Commercial Robbery",
    NIBRS_Offense_Code == "120" & `Location Description` == "OTHER" ~ 
      "12U Other Robbery",
    NIBRS_Offense_Code == "120" ~ "12A Personal Robbery",
    TRUE ~ NIBRS_Offense_Code
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  # save data
  save_city_data("Chicago") %>% 
  glimpse()
```


# Detroit

Detroit data changed format at the end of 2016. Although the column names 
changed, the information provided in the two files is largely the same. Offences
occurring on 6 December 2016 can appear in either file, but do not appear to be
duplicated. The newer file contains far fewer records overall, but this is
because of a substantial reduction in non-criminal incidents recorded in the 
later file. There are, however, some differences in the categorisations:

  * 11A Rape (except Statutory Rape), 11C Sexual Assault With An Object, 
    11D Fondling, 36B Statutory Rape and 40A Prostitution only appear in the new 
    file.
  * There is a large decrease in crimes in 13C Intimidation and 210 
    Extortion/Blackmail in 2017, for which there is no obvious cause.
  * In the new file, commercial and personal robbery can no longer be 
    distinguished, so almost all robberies are coded as 12U Other Robbery.
    Similarly it is no longer possible to distinguish between residential and
    non-residential burglary, so all burglaries from 2017 onwards are classified 
    as 22U Other Burglary/Breaking & Entering.
  * There are large increases in 26B Credit Card/Automated Teller Machine Fraud
    and 26E Wire Fraud together with an even larger decreases in 26A 
    False Pretenses/Swindle/Confidence Game and 270 Embezzlement.
  * There is a large increase in 90F Family Offenses, Nonviolent offences.

```{r}
list(
  read_csv("../original_data/Detroit 2009 to 2016.csv", 
           col_types = cols(.default = col_character())) %>%
    select(-ROWNUM, -CASEID, -CENSUSTRACT) %>% 
    separate(LOCATION, into = c("Incident Address", "LOCATION"), sep = "\\n") %>% 
    mutate(
      HOUR = paste0(str_pad(HOUR, width = 2, side = "left", pad = "0"), "00"),
      SCA = str_pad(SCA, width = 4, side = "left", pad = "0"),
      PRECINCT = str_pad(PRECINCT, width = 2, side = "left", pad = "0"),
      COUNCIL = str_remove(COUNCIL, "City Council District ")
    ),
  read_csv("../original_data/Detroit 2016 to date.csv", 
           col_types = cols(.default = col_character())) %>% 
    select(-`Day of Week (Sunday is 1)`, -`Hour of Day`,
           -Year, -`Census Block GEOID`, -Longitude, -Latitude, -`Zip Code`) %>% 
    rename(
      CRIMEID = `Crime ID`,
      CRNO = `Report #`,
      OFFENSEDESCRIPTION = `Offense Description`,
      CATEGORY = `Offense Category`,
      STATEOFFENSEFILECLASS = `State Offense Code`,
      INCIDENTDATE = `Incident Date & Time`,
      HOUR = `Incident Time (24h)`,
      SCA = `Scout Car Area`,
      PRECINCT = `Precinct Number`,
      LOCATION = `Location`,
      NEIGHBORHOOD = `Neighborhood`,
      COUNCIL = `Council District`
    ) %>% 
    mutate(
      NEIGHBORHOOD = str_to_upper(NEIGHBORHOOD),
      LOCATION = str_remove(LOCATION, "^location\\n"),
      `Incident Address` = str_remove_all(`Incident Address`, "block of ")
    )
) %>% 
  bind_rows() %>% 
  mutate(
    LOCATION = str_replace(LOCATION, ".*\\((.+)\\)", "\\1"),
    INCIDENTDATE = paste(parse_date(INCIDENTDATE, "%m/%d/%Y %I:%M:%S %p"), HOUR)
  ) %>% 
  separate(LOCATION, c("Latitude", "Longitude"), ", ") %>% 
  add_date_var("INCIDENTDATE", "Ymd R", "America/Detroit") %>%
  filter_by_year(2009, yearLast) %>% 
  left_join(read_csv("../crime_categories/categories_Detroit.csv"), 
            by = c("CATEGORY", "OFFENSEDESCRIPTION")) %>% 
  save_city_data("Detroit") %>% 
  glimpse()
  # filter(is.na(NIBRS_Offense_Category)) %>% 
  # group_by(Date.Year, NIBRS_Offense_Type) %>% 
  # summarise(n = n()) %>% 
  # spread(Date.Year, n) %>% 
  # arrange(NIBRS_Offense_Type) %>% 
  # View()
  # write_csv("../crime_categories/categories_Detroit_temp.csv")
  # mutate(month = month(Date.Single)) %>% 
  # group_by(Date.Year, month) %>%
  # summarise(n = n()) %>% 
  # spread(month, n)
```

```{r}
read_csv('../original_data/Detroit 2009 to date.csv', 
                     col_types = cols(
                       .default = col_character(),
                       ROWNUM = col_integer(),
                       CASEID = col_integer(),
                       CRIMEID = col_integer(),
                       HOUR = col_integer(),
                       LON = col_double(),
                       LAT = col_double()
                     )) %>% 
  rename(Longitude = LON, Latitude = LAT, NHOOD = NEIGHBORHOOD) %>% 
  mutate(INCIDENTDATE = paste0(INCIDENTDATE, ' ', HOUR, ':00')) %>% 
  add_date_var("INCIDENTDATE", "mdY R", "America/Detroit") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(read_csv("../crime_categories/categories_Detroit.csv"), 
            by = c("CATEGORY", "OFFENSEDESCRIPTION")) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    OFFENSEDESCRIPTION %in% c("BURGLARY - BURGLARY - FORCED ENTRY - RESIDENCE",
      "BURGLARY - NO FORCED ENTRY - RESIDENCE", 
      "BURGLARY - FORCED ENTRY -  RESIDENCE", 
      "BURGLARY - ENTRY WITHOUT FORCE - RESIDENCE") ~ 
      "22A Domestic Burglary/Breaking & Entering",
    CATEGORY == "BURGLARY" ~ "22B Non-domestic Burglary/Breaking & Entering",
    OFFENSEDESCRIPTION %in% c("ROBBERY - STREET - GUN", 
      "ROBBERY - STREET - STRONG ARM", "ROBBERY - MOTOR VEHICLE (CAR JACKING)",
      "ROBBERY - STREET - OTHER WEAPON", "ROBBERY - RESIDENCE - GUN", 
      "ROBBERY - RESIDENCE - STRONG ARM", "ROBBERY - FORCIBLE PURSESNATCHING", 
      "ROBBERY - RESIDENCE - OTHER WEAPON", 
      "ROBBERY - MOTOR VEHICLE (CARJACKING)") ~ "12A Personal Robbery",
    OFFENSEDESCRIPTION %in% c("ROBBERY - BUSINESS - GUN", 
      "ROBBERY - BUSINESS - STRONG ARM", "ROBBERY - BUSINESS - OTHER WEAPON",
      "ROBBERY - BANKING TYPE INSTITUTION") ~ "12B Commercial Robbery",
    CATEGORY == "ROBBERY" ~ "12U Other Robbery",
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  save_city_data("Detroit") %>% 
  glimpse()
```


# Fort Worth

Data are from https://data.fortworthtexas.gov/Public-Safety/Crime-Data/k6ic-7kp7

The `Offense` column seems to contain NIBRS codes, so it's just necessary to 
match the codes to the offence categories. This can be done directly by using 
the look-up table, so there is no need to create a mapping between local offence 
codes and NIBRS codes as there is for other cities.

```{r}
read_csv('../original_data/Fort Worth time period to be checked.csv', 
         col_types = cols(
           .default = col_character(),
           `Case Number` = col_integer(),
           `Council District` = col_integer(),
           `Location Type` = col_integer()
         )) %>% 
  mutate(
    Location = str_replace(Location, ".*\\((.+)\\)", "\\1")
  ) %>% 
  separate(Location, c("Latitude", "Longitude"), ", ") %>% 
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>% 
  add_date_var("From Date", 'mdY T', "America/Chicago") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(nibrs_categories, by = "Offense") %>% 
  mutate(NIBRS_Offense_Type = case_when(
    NIBRS_Offense_Code == "220" & `Location Description` == "Residence, home" ~ 
      "22A Domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "120" & `Location Description` %in% c(
      "Highway, street, roadway, alley", "Parking lot, garage", 
      "Residence, home", "Field, woods", "Park/Playground", 
      "Airplane, bus, train terminal", "School, college", "Shopping Mall",
      "Lake, waterway", "School-Elementary/Secondary", "ATM separate from Bank",
      "Rest Area", "School-College/University") ~ "12A Personal Robbery",
    NIBRS_Offense_Code == "120" & `Location Description` == "Other, unknown" ~ 
      "12U Other Robbery",
    NIBRS_Offense_Code == "120" ~ "12B Commercial Robbery",
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  save_city_data("Fort Worth") %>% 
  glimpse()
```


# Los Angeles

LA data include multiple offences occurring during the same incident in a single 
row, so to make them equivalent to the other cities these data should be 
converted from long to wide.

Most categories can be extracted from the `Crime Code Description` field, but 
for some offences it may be necessary to look at the MO used, as coded in the 
`MO Codes` field. The `MO Codes` field is a space-separated list of codes, 
meaning a lookup table can't be created as for other cities. As such, to 
generate the NIBRS for LA data, we need to:

  1. use the `Crime Code Description` field and -- where necessary -- the 
     `MO Codes` field to allocate a NIBRS category to each record, then
  2. use that NIBRS category to match all the other NIBRS columns.

```{r}
read_csv('../original_data/Los Angeles 2010 to date.csv', 
         col_types = cols(
           .default = col_character(),
           `Crime Code` = col_integer(),
           `Victim Age` = col_integer(),
           `Premise Code` = col_integer(),
           `Weapon Used Code` = col_integer(),
           `Crime Code 1` = col_integer(),
           `Crime Code 2` = col_integer(),
           `Crime Code 3` = col_integer(),
           `Crime Code 4` = col_integer()
         )) %>% 
# convert from wide to long
# This code converts the four crime-code fields into wide format while 
# duplicating all the other columns across each new row. The `gather` function 
# requires that all variables to be left alone be specified, so a `setdiff` 
# function is used to return all the variables that are not one of the 
# crime-code fields.
  gather(
    WhichCrime, 
    CrimeType, 
    `Crime Code 1`, 
    `Crime Code 2`, 
    `Crime Code 3`, 
    `Crime Code 4`, 
    -one_of(setdiff(
      names(.), 
      c('Crime Code 1', 'Crime Code 2', 'Crime Code 3', 'Crime Code 4')
    )), 
    na.rm = TRUE) %>% 
  mutate(
    Location = str_replace(Location, "\\((.+?)\\)", "\\1"),
    `Date Occurred` = paste(`Date Occurred`, `Time Occurred`)
  ) %>% 
  separate(Location, c("Latitude", "Longitude"), ", ") %>% 
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>% 
  add_date_var("Date Occurred", "mdY R", "America/Los_Angeles") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  mutate(
    # convert empty `MO Codes` fields from NA to an empty string, which makes it 
    # easier to search that field later
    `MO Codes` = if_else(is.na(`MO Codes`), "", `MO Codes`),
    NIBRS_Offense_Type = case_when(

      # Arson
      `Crime Code Description` %in% c('ARSON') ~ '200 Arson',
      
      # Assault
      `Crime Code Description` %in% c(
        'ASSAULT WITH DEADLY WEAPON ON POLICE OFFICER', 
        'ASSAULT WITH DEADLY WEAPON, AGGRAVATED ASSAULT', 
        'INTIMATE PARTNER - AGGRAVATED ASSAULT', 
        'CHILD ABUSE (PHYSICAL) - AGGRAVATED ASSAULT') ~ 
        '13A Aggravated assault',
      `Crime Code Description` %in% c(
        'BATTERY - SIMPLE ASSAULT', 'BATTERY ON A FIREFIGHTER', 
        'BATTERY POLICE (SIMPLE)', 'INTIMATE PARTNER - SIMPLE ASSAULT', 
        'OTHER ASSAULT', 'CHILD ABUSE (PHYSICAL) - SIMPLE ASSAULT', 
        'RESISTING ARREST') ~ '13B Simple assault',
      `Crime Code Description` %in% c('CRIMINAL THREATS - NO WEAPON DISPLAYED', 
        'STALKING', 'BOMB SCARE', 'THREATENING PHONE CALLS/LETTERS') ~ 
        '13C Intimidation',
      
      # Bribery
      `Crime Code Description` %in% c('BRIBERY') ~ '510 Bribery',
      
      # Burglary/Breaking & Entering
      `Crime Code Description` %in% c('BURGLARY', 'BURGLARY, ATTEMPTED') &
        `Premise Description` %in% c("SINGLE FAMILY DWELLING", 
          "MULTI-UNIT DWELLING (APARTMENT, DUPLEX, ETC)", "GARAGE/CARPORT", 
          "OTHER RESIDENCE", "CONDOMINIUM/TOWNHOUSE", 
          "MOBILE HOME/TRAILERS/CONSTRUCTION TRAILERS/RV'S/MOTORHOME", 
          "NURSING/CONVALESCENT/RETIREMENT HOME", 
          "FRAT HOUSE/SORORITY/DORMITORY", "PROJECT/TENEMENT/PUBLIC HOUSING", 
          "GROUP HOME", "PORCH, RESIDENTIAL", "FOSTER HOME BOYS OR GIRLS*") ~ 
        "22A Domestic Burglary/Breaking & Entering",
      `Crime Code Description` %in% c('BURGLARY', 'BURGLARY, ATTEMPTED') ~ 
        "22B Non-domestic Burglary/Breaking & Entering",

      # Counterfeiting/Forgery
      `Crime Code Description` %in% c('COUNTERFEIT', 
        'DOCUMENT FORGERY / STOLEN FELONY') ~ '250 Counterfeiting/Forgery',
      
      # Destruction/Damage/Vandalism of Property (except Arson)
      `Crime Code Description` %in% c(
        'VANDALISM - FELONY ($400 & OVER, ALL CHURCH VANDALISMS) 0114', 
        'VANDALISM - MISDEAMEANOR ($399 OR UNDER)', 
        'TELEPHONE PROPERTY - DAMAGE') ~ 
        '290 Destruction/Damage/Vandalism of Property (except Arson)',
      
      # Embezzlement
      `Crime Code Description` %in% c(
        'EMBEZZLEMENT, GRAND THEFT ($950.01 & OVER)', 
        'EMBEZZLEMENT, PETTY THEFT ($950 & UNDER)', 
        'DISHONEST EMPLOYEE - GRAND THEFT', 'DISHONEST EMPLOYEE - PETTY THEFT', 
        'DISHONEST EMPLOYEE ATTEMPTED THEFT') ~ '270 Embezzlement',
      
      # Extortion/Blackmail
      `Crime Code Description` %in% c('EXTORTION') ~ '210 Extortion/Blackmail',
      
      # Fraud Offenses (except Counterfeiting/Forgery and Bad Checks)
      `Crime Code Description` %in% c(
        'DEFRAUDING INNKEEPER/THEFT OF SERVICES, $400 & UNDER', 
        'DEFRAUDING INNKEEPER/THEFT OF SERVICES, OVER $400', 'BUNCO, ATTEMPT', 
        'BUNCO, GRAND THEFT', 'BUNCO, PETTY THEFT', 
        'GRAND THEFT / INSURANCE FRAUD') ~ 
        '26A False Pretenses/Swindle/Confidence Game',
      `Crime Code Description` %in% c('CREDIT CARDS, FRAUD USE ($950 & UNDER', 
        'CREDIT CARDS, FRAUD USE ($950.01 & OVER)') ~ 
        '26B Credit Card/Automated Teller Machine Fraud',
      `Crime Code Description` %in% c('THEFT OF IDENTITY') ~ 
        '26C Impersonation',
      `Crime Code Description` %in% c('UNAUTHORIZED COMPUTER ACCESS') ~ 
        '26E Wire Fraud',
      
      # Homicide Offenses
      `Crime Code Description` %in% c('CRIMINAL HOMICIDE') ~ 
        '09A Murder and Nonnegligent Manslaughter',
      `Crime Code Description` %in% c('MANSLAUGHTER, NEGLIGENT') ~ 
        '09B Negligent Manslaughter',
      
      # Kidnapping/Abduction
      `Crime Code Description` %in% c('CHILD STEALING', 'FALSE IMPRISONMENT', 
        'KIDNAPPING', 'KIDNAPPING - GRAND ATTEMPT') ~ 
        '100 Kidnapping/Abduction',
      
      # Larceny/Theft Offenses
      `Crime Code Description` %in% c('PICKPOCKET', 'PICKPOCKET, ATTEMPT', 
        'DRUNK ROLL', 'DRUNK ROLL - ATTEMPT') ~ '23A Pocket-picking',
      `Crime Code Description` %in% c('PURSE SNATCHING', 
        'PURSE SNATCHING - ATTEMPT') ~ '23B Purse-snatching',
      `Crime Code Description` %in% c('SHOPLIFTING - ATTEMPT', 
        'SHOPLIFTING - PETTY THEFT ($950 & UNDER)', 
        'SHOPLIFTING-GRAND THEFT ($950.01 & OVER)') ~ '23C Shoplifting',
      `Crime Code Description` %in% c('TILL TAP - ATTEMPT', 
        'TILL TAP - GRAND THEFT ($950.01 & OVER)', 
        'TILL TAP - PETTY ($950 & UNDER)') ~ '23D Theft From Building',
      `Crime Code Description` %in% c('THEFT, COIN MACHINE - ATTEMPT', 
        'THEFT, COIN MACHINE - GRAND ($950.01 & OVER)', 
        'THEFT, COIN MACHINE - PETTY ($950 & UNDER)') ~ 
        '23E Theft From Coin-Operated Machine or Device',
      `Crime Code Description` %in% c('THEFT FROM MOTOR VEHICLE - ATTEMPT', 
        'THEFT FROM MOTOR VEHICLE - GRAND ($400 AND OVER)', 
        'THEFT FROM MOTOR VEHICLE - PETTY ($950 & UNDER)', 
        'BURGLARY FROM VEHICLE', 'BURGLARY FROM VEHICLE, ATTEMPTED') ~ 
        '23F Theft From Motor Vehicle (except Theft of Motor Vehicle Parts or Accessories)',
      `Crime Code Description` %in% c('THEFT PLAIN - ATTEMPT', 
        'THEFT PLAIN - PETTY ($950 & UNDER)', 
        'THEFT-GRAND ($950.01 & OVER)EXCPT,GUNS,FOWL,LIVESTK,PROD0036', 
        'BIKE - ATTEMPTED STOLEN', 'BIKE - STOLEN', 'BOAT - STOLEN', 
        'GRAND THEFT / AUTO REPAIR', 'PETTY THEFT - AUTO REPAIR', 
        'THEFT, PERSON', 'THEFT FROM PERSON - ATTEMPT') ~ 
        '23H All Other Larceny',
      # some 23A and 23B offences are coded using a combination of crime codes 
      # and MO codes, so have to be done after the other larceny categories are 
      # created
      `Crime Code Description` %in% c('THEFT, PERSON', 
        'THEFT FROM PERSON - ATTEMPT') & 
        str_count(`MO Codes`, pattern = '0357') > 0 ~ '23A Pocket-picking',
      `Crime Code Description` %in% c('THEFT, PERSON', 
        'THEFT FROM PERSON - ATTEMPT') & str_count(`MO Codes`, 
          pattern = '0336|0337|0341|0342|0343|0346|0355') > 0 ~ 
        '23B Purse-snatching',
      # 23G offences are identified using an MO code that can be present in 
      # several crime categories, so this assignment has to be done after all 
      # the other theft categories are created
      `Crime Code Description` %in% c('BURGLARY FROM VEHICLE', 
        'BURGLARY FROM VEHICLE, ATTEMPTED', 'THEFT FROM MOTOR VEHICLE - ATTEMPT', 
        'THEFT FROM MOTOR VEHICLE - GRAND ($400 AND OVER)', 
        'THEFT FROM MOTOR VEHICLE - PETTY ($950 & UNDER)', 
        'THEFT PLAIN - ATTEMPT', 'THEFT PLAIN - PETTY ($950 & UNDER)', 
        'THEFT-GRAND ($950.01 & OVER)EXCPT,GUNS,FOWL,LIVESTK,PROD0036') & 
        str_count(`MO Codes`, pattern = '0385') > 0 ~ 
        '23G Theft of Motor Vehicle Parts or Accessories',
      
      # Motor Vehicle Theft
      `Crime Code Description` %in% c('VEHICLE - STOLEN', 
        'VEHICLE - ATTEMPT STOLEN', 'DRIVING WITHOUT OWNER CONSENT (DWOC)') ~ 
        '240 Motor Vehicle Theft',
      
      # Prostitution Offenses
      `Crime Code Description` %in% c('PIMPING') ~ 
        '40B Assisting or Promoting Prostitution',
      `Crime Code Description` %in% c('PANDERING') ~ 
        '40C Purchasing Prostitution',
      
      # Robbery
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') & 
        `Premise Description` %in% c("STREET", "SIDEWALK", "PARKING LOT", 
          "MULTI-UNIT DWELLING (APARTMENT, DUPLEX, ETC)", 
          "SINGLE FAMILY DWELLING", "MARKET", "ALLEY", "BUS STOP", 
          "PARK/PLAYGROUND", "DRIVEWAY", "HIGH SCHOOL", 
          "YARD (RESIDENTIAL/BUSINESS)", "VEHICLE, PASSENGER/TRUCK", 
          "BUS STOP OR LAYOVER", "GARAGE/CARPORT", "JUNIOR HIGH SCHOOL",
          "PARKING UNDERGROUND/BUILDING", "AUTOMATED TELLER MACHINE (ATM)",
          "BEACH", "PROJECT/TENEMENT/PUBLIC HOUSING", "OTHER RESIDENCE",
          "ELEMENTARY SCHOOL", "PORCH, RESIDENTIAL", 
          "CHARTER BUS AND PRIVATELY OWNED BUS", "FREEWAY", 
          "PUBLIC RESTROOM/OUTSIDE*", "STAIRWELL*", "MTA BUS", 
          "PUBLIC RESTROOM(INDOORS-INSIDE)", "RIVER BED*", 
          "CONDOMINIUM/TOWNHOUSE", "SKATEBOARD FACILITY/SKATEBOARD PARK*",
          "COLLEGE/JUNIOR COLLEGE/UNIVERSITY", "TRAIN", 
          "MOBILE HOME/TRAILERS/CONSTRUCTION TRAILERS/RV'S/MOTORHOME",
          "MTA PROPERTY OR PARKING LOT", "UNDERPASS/BRIDGE*", "ELEVATOR",
          "GROUP HOME", "PATIO*", "PEDESTRIAN OVERCROSSING", 
          "SPECIALTY SCHOOL/OTHER", "METROLINK TRAIN", "VACANT LOT", 
          "ABANDONED BUILDING ABANDONED HOUSE", "REDLINE ENTRANCE/EXIT",
          "TRANSPORTATION FACILITY (AIRPORT)", "BUS, SCHOOL, CHURCH",
          "TRAIN TRACKS", "TUNNEL", "OTHER RR TRAIN (UNION PAC, SANTE FE ETC",
          "PAY PHONE", "REDLINE SUBWAY PLATFORM", "TERMINAL", 
          "MUNICIPAL BUS LINE INCLUDES LADOT/DASH", 
          "POOL-PUBLIC/OUTDOOR OR INDOOR*", "PRIVATE SCHOOL/PRESCHOOL",
          "REDLINE (SUBWAY TRAIN)", "SLIPS/DOCK/MARINA/BOAT", 
          "BLUE LINE (ABOVE GROUND SURFACE TRAIN)", "FOSTER HOME BOYS OR GIRLS*",
          "FRAT HOUSE/SORORITY/DORMITORY", "GOLF COURSE*", 
          "GREEN LINE (I-105 FWY LEVEL TRAIN)") ~ "12A Personal Robbery",
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') & 
        (`Premise Description` %in% c("OTHER PREMISE", "OTHER/OUTSIDE") | 
           is.na(`Premise Description`)) ~ "12U Other Robbery",
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') ~ 
        "12B Commercial Robbery",

      # Sex Offenses
      `Crime Code Description` %in% c('RAPE, ATTEMPTED', 'RAPE, FORCIBLE') ~ 
        '11A Rape (except Statutory Rape)',
      `Crime Code Description` %in% c('SODOMY/SEXUAL CONTACT B/W PENIS OF ONE PERS TO ANUS OTH 0007=02',
        'ORAL COPULATION') ~ '11B Sodomy',
      `Crime Code Description` %in% c('SEXUAL PENTRATION WITH A FOREIGN OBJECT') ~
        '11C Sexual Assault With An Object',
      `Crime Code Description` %in% c('BATTERY WITH SEXUAL CONTACT') ~ 
        '11D Fondling',
      
      # Sex Offenses, Nonforcible
      `Crime Code Description` %in% c('INCEST (SEXUAL ACTS BETWEEN BLOOD RELATIVES)') ~ 
        '36A Incest',
      `Crime Code Description` %in% c('SEX, UNLAWFUL') ~ '36B Statutory Rape',
      # The offence of 'CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060'
      # is problematic because it covers a wide array of behaviour. Offenses
      # matching specific criteria are allocated to particular categories, with
      # all remaining offences being allocated to category 90Z. The specific 
      # offences are ordered by decreasing severity, since an offence may match 
      # multiple MO codes.
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0527|0533') > 0 ~ '36B Statutory Rape',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0507|0512|0519|0521|0539|0540|0541|0548|0549') > 0
      ~ '11B Sodomy',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0515') > 0 ~ 
        '11C Sexual Assault With An Object',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0500|0501|0502|0503|0504|0505|0506|0509|0510|0511|0517|0518|0522|0528|0532|0537|0543|0544|0550|0551') > 0 
      ~ '11D Fondling',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0529|0538') > 0 ~ 
        '90C Disorderly Conduct',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      ~ '90Z All Other Offenses',
      
      # Weapon Law Violations
      `Crime Code Description` %in% c('BRANDISH WEAPON', 
        'WEAPONS POSSESSION/BOMBING', 
        'FIREARMS EMERGENCY PROTECTIVE ORDER (FIREARMS EPO)', 
        'DISCHARGE FIREARMS/SHOTS FIRED', 
        'REPLICA FIREARMS(SALE,DISPLAY,MANUFACTURE OR DISTRIBUTE)0132', 
        'SHOTS FIRED AT INHABITED DWELLING', 
        'SHOTS FIRED AT MOVING VEHICLE, TRAIN OR AIRCRAFT') ~ 
        '520 Weapon Law Violations',
      
      # Bad Checks (except Counterfeit Checks or Forged Checks)
      `Crime Code Description` %in% c('DOCUMENT WORTHLESS ($200 & UNDER)', 
        'DOCUMENT WORTHLESS ($200.01 & OVER)') ~ 
        '90A Bad Checks (except Counterfeit Checks or Forged Checks)',
      
      # Curfew/Loitering/Vagrancy Violations
      `Crime Code Description` %in% c('FAILURE TO DISPERSE', 
        'BLOCKING DOOR INDUCTION CENTER') ~ 
        '90B Curfew/Loitering/Vagrancy Violations',
      
      # Disorderly Conduct
      `Crime Code Description` %in% c('DISTURBING THE PEACE', 'DISRUPT SCHOOL', 
        'INCITING A RIOT', 'INDECENT EXPOSURE', 'LEWD CONDUCT', 
        'THROWING OBJECT AT MOVING VEHICLE') ~ '90C Disorderly Conduct',
      
      # Family Offenses, Nonviolent
      `Crime Code Description` %in% c('CHILD ABANDONMENT', 
        'CHILD NEGLECT (SEE 300 W.I.C.)') ~ '90F Family Offenses, Nonviolent',
      
      # Peeping Tom
      `Crime Code Description` %in% c('PEEPING TOM') ~ '90H Peeping Tom',

      # Trespass of Real Property
      `Crime Code Description` %in% c('PROWLER', 'TRESPASSING') ~ 
        '90J Trespass of Real Property',
      
      # All Other Offenses
      `Crime Code Description` %in% c('ABORTION/ILLEGAL', 
        'BEASTIALITY, CRIME AGAINST NATURE SEXUAL ASSLT WITH ANIM0065', 'BIGAMY', 
        'CHILD ANNOYING (17YRS & UNDER)', 'CONSPIRACY', 'CONTEMPT OF COURT', 
        'CONTRIBUTING', 'CRUELTY TO ANIMALS', 'FALSE POLICE REPORT', 
        'ILLEGAL DUMPING', 'LYNCHING', 'LYNCHING - ATTEMPTED', 
        'VIOLATION OF COURT ORDER', 'VIOLATION OF RESTRAINING ORDER', 
        'VIOLATION OF TEMPORARY RESTRAINING ORDER', 'LETTERS, LEWD', 
        'OTHER MISCELLANEOUS CRIME') ~ '90Z All Other Offenses',
      
      # Not-categorisable offences
      # Where it is clear that not all the offences that should be present are 
      # present in the data, it would be misleading to populate those 
      # categories. Offences within such categories that are present are 
      # categorised here so that they can be stripped from the analysis.
      `Crime Code Description` %in% c('DRUGS, TO A MINOR') ~ 
        '99X Non-Categorisable Offenses',

      # Non-reportable crimes
      `Crime Code Description` %in% c('FAILURE TO YIELD', 'RECKLESS DRIVING') ~
        '99Y Non-Reportable Crimes'

    )
  ) %>% 
  left_join(nibrs_categories, by = "NIBRS_Offense_Type") %>% 
  # sample_n(50) %>% 
  # View()
  # where necessary, update the NIBRS code to match the new type
  mutate(NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>%
  save_city_data("Los Angeles") %>%
  glimpse()
```


# Louisville

Louisville has a field called `NIBRS_CODE` that can be used to match the various 
levels of the NIBRS hierarchy. However, some incidents that Louisville 
categorises as 90Z should actually be in other categories, e.g. because they are 
not criminal or are criminal but are not NIBRS reportable. These need to be 
reallocated manually.

```{r}
dir(path = "../original_data", pattern = 'Louisville*', 
    full.names = TRUE) %>% 
  map(read_csv, col_types= cols(
    .default = col_character(),
    ID = col_integer()
  )) %>% 
  reduce(rbind) %>% 
  add_date_var("DATE_OCCURED", "Ymd T", "America/Kentucky/Louisville") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(nibrs_categories, by = c("NIBRS_CODE" = "Offense")) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    
    # Disorderly conduct
    UOR_DESC %in% c('INDECENT EXPOSURE - 1ST DEGREE - 1ST OFFENSE',
      'INDECENT EXPOSURE - 1ST DEGREE - 2ND OFFENSE', 
      'INDECENT EXPOSURE - 1ST DEGREE - 3RD OFFENSE', 
      'INDECENT EXPOSURE - 1ST DEGREE - 4TH OR > OFFENSE', 
      'INDECENT EXPOSURE - 2ND DEGREE') ~ '90C Disorderly Conduct',
    
    # Non-reportable crimes
    UOR_DESC %in% c('DISPLAY OF ILLEGAL/ALTERED REGISTRATION PLATE',
      'FAIL OF NON-OWNER/OPER TO MAINTAIN REQ INS/SECURITY 1ST OFF',
      'FAIL OF TRANSFEREE OF VEH TO PROMPTLY APPLY FOR NEW TITLE',
      'FAILURE OF OWNER TO MAINTAIN REQUIRED INS/SECURITY 1ST OFF',
      'FAILURE OF OWNER TO MAINTAIN REQUIRED INS/SECURITY 2ND OFF',
      'FAILURE OF SELLER TO DELIVER REGISTRATION W/ASSIGNMENT FORM',
      'IMPROPER EMERGENCY/SAFETY LIGHTS',
      'LEAV SCENE OF ACCIDENT/FAIL TO RNDR AID/ASSIST W/DEATH OR SJ',
      'MOTOR VEH DEALER REQ TO GIVE TITLE TO PURCHASER',
      'MOTOR VEHICLE DEALER LICENSE REQUIRED',
      'POSSESSING LICENSE WHEN PRIVILEGES ARE REVOKED') ~ 
      '99Y Non-Reportable Crimes',
    
    # Non-criminal matters
    UOR_DESC %in% c('ACCIDENTAL DEATH (DROWNING)', 
      'ACCIDENTAL DEATH (OTHER THAN DROWNING AND HUNTING)',
      'ACCIDENTAL SHOOTING (OTHER THAN HUNTING)',
      'DOMESTIC ABUSE DUTIES OF LAW ENFORCEMENT',
      'EMERGENCY ADMIT,MENTAL HEALTH HOSP.-UNIFIED JUV CO',
      'EMERGENCY CUSTODY ORDERS UNIFIED JUVENILE CODE',
      'INVOLUN ADMIT MENTAL HEALTH HOSP - UNIFIED JUV CODE',
      'INVOLUNTARY HOSPITALIZATION OF MENTALLY ILL - 60/360 DAYS',
      'NON-CRIMINAL DEATH (NATURAL CAUSES)',
      'PROPERTY LOST OR ABANDONED NON CRIMINAL',
      'RECOVERY OF STOLEN PROPERTY',
      'SERVING BENCH WARRANT FOR COURT',
      'SERVING WARRANT (FOR OTHER POLICE AGENCY)') ~ '99Z Non-Criminal Matters',
    
    # burglary
    NIBRS_CODE == "220" & PREMISE_TYPE %in% c("RESIDENCE / HOME", 
      "PARKING LOT / GARAGE", "OTHER RESIDENCE (APARTMENT/CONDO)", 
      "ATTACHED RESIDENTIAL GARAGE", "PARKING LOT / GARAGE") ~ 
      "22A Domestic Burglary/Breaking & Entering",
    NIBRS_CODE == "220" ~ "22B Non-domestic Burglary/Breaking & Entering",
    
    # robbery
    NIBRS_CODE == "120" & PREMISE_TYPE %in% c("HIGHWAY / ROAD / ALLEY", 
      "RESIDENCE / HOME", "PARKING LOT / GARAGE", 
      "OTHER RESIDENCE (APARTMENT/CONDO)", "SCHOOL - ELEMENTARY / SECONDARY", 
      "FIELD / WOODS", "AIR / BUS / TRAIN TERMINAL", "ATM SEPARATE FROM BANK",
      "SCHOOL - COLLEGE / UNIVERSITY") ~ "12A Personal Robbery",
    NIBRS_CODE == "120" & PREMISE_TYPE == "OTHER / UNKNOWN" ~ 
      "12U Other Robbery",
    NIBRS_CODE == "120" ~ "12B Commercial Robbery",
    
    # all other crimes
    TRUE ~ NIBRS_Offense_Type
      
  )) %>% 
  # consequently some higher-level NIBRS fields need to be changed
  mutate(
    NIBRS_Offense_Category = if_else(
      NIBRS_Offense_Type %in% c('99Y Non-Reportable Crimes', 
                                '99Z Non-Criminal Matters'), 
      'Excluded cases', NIBRS_Offense_Category),
    NIBRS_Crime_Against = if_else(
      NIBRS_Offense_Type %in% c('99Y Non-Reportable Crimes', 
                                '99Z Non-Criminal Matters'), 
      'Excluded cases', NIBRS_Crime_Against),
    NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  save_city_data("Louisville") %>% 
  glimpse()
```


# New York

```{r}
# load datasets
read_csv('../original_data/New York 2006 to 2017.csv', 
         col_types = cols(
           .default = col_character(),
           CMPLNT_NUM = col_integer(),
           KY_CD = col_integer(),
           PD_CD = col_integer(),
           ADDR_PCT_CD = col_integer(),
           X_COORD_CD = col_integer(),
           Y_COORD_CD = col_integer(),
           Latitude = col_double(),
           Longitude = col_double()
         )
  ) %>% 
  report_status("File read") %>% 
  # since NYC includes both start and end dates, so we will process the dates
  # manually rather than using add_date_var()
  mutate(
    # Some early NYC offences have times equal to 24:00:00, which cannot be 
    # parsed by R date functions
    CMPLNT_FR_TM = if_else(CMPLNT_FR_TM == "24:00:00", "23:59:59", CMPLNT_FR_TM),
    CMPLNT_TO_TM = if_else(CMPLNT_TO_TM == "24:00:00", "23:59:59", CMPLNT_TO_TM),
    # For offences with only one date, there is some inconsistency in which date 
    # is included. In almost all cases the start date is the date provided, but 
    # occasionally only the end date is present. The next line copies the 
    # single date from the end date to the start date and (separtely) the single
    # time to end date to the start date.
    CMPLNT_FR_DT = ifelse(is.na(CMPLNT_FR_DT), CMPLNT_TO_DT, CMPLNT_FR_DT),
    CMPLNT_FR_TM = ifelse(is.na(CMPLNT_FR_TM), CMPLNT_TO_TM, CMPLNT_FR_TM),
    # For offences with a time but no date in either column, use the reported 
    # date as the start date
    CMPLNT_FR_DT = ifelse(is.na(CMPLNT_FR_DT) & !is.na(CMPLNT_FR_TM), RPT_DT, 
                          CMPLNT_FR_DT)
  ) %>% 
  report_status("Impossible times changed") %>% 
  # Now we can convert the date strings to date objects
  mutate(
    Date.Start.Temp = parse_date_time(paste(CMPLNT_FR_DT, CMPLNT_FR_TM), 'mdY T', 
                                      tz = 'America/New_York'),
    Date.End.Temp = parse_date_time(paste(CMPLNT_TO_DT, CMPLNT_TO_TM), 'mdY T', 
                                    tz = 'America/New_York'),
    Date.Temp = strftime(Date.Start.Temp + ((Date.End.Temp - Date.Start.Temp)/2), 
                         format = '%Y-%m-%d %H:%M', tz = 'America/New_York'),
    Date.Temp = ifelse(is.na(Date.Temp), 
                       strftime(Date.Start.Temp, format = "%Y-%m-%d %H:%M", 
                                tz = 'America/New_York'), 
                       Date.Temp),
    Date.Year = year(Date.End.Temp),
    Date.Start = strftime(Date.Start.Temp, format = '%Y-%m-%d %H:%M', 
                          tz = 'America/New_York'),
    Date.End = strftime(Date.End.Temp, format = '%Y-%m-%d %H:%M', 
                        tz = 'America/New_York'),
    Date.Single = strftime(Date.Temp, format = '%Y-%m-%d %H:%M', 
                           tz = 'America/New_York'),
    Multiple.Dates = TRUE
  ) %>% 
  select(-Date.Start.Temp, -Date.End.Temp, -Date.Temp) %>% 
  report_status("Strings converted to dates") %>% 
  {
    cat("  Failures:  Date.Start:", sum(is.na(.$Date.Start)), " Date.End:", 
        sum(is.na(.$Date.End)), " Date.Single:", sum(is.na(.$Date.Single)), 
        "\n")
    .
  } %>% 
  filter_by_year(2007, yearLast) %>% 
  report_status("Matching cases to NIBRS categories") %>% 
  left_join(read_csv("../crime_categories/categories_NYC.csv"), 
            by = c('OFNS_DESC', 'PD_DESC')) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    # burglary
    NIBRS_Offense_Code == "220" & PD_DESC %in% c("BURGLARY,RESIDENCE,DAY", 
      "BURGLARY,RESIDENCE,NIGHT", "BURGLARY,RESIDENCE,UNKNOWN TIM") ~ 
      "22A Domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-domestic Burglary/Breaking & Entering",
    
    # robbery
    NIBRS_Offense_Code == "120" & PD_DESC %in% c(
      "ROBBERY,PERSONAL ELECTRONIC DEVICE",
      "ROBBERY,OPEN AREA UNCLASSIFIED", "ROBBERY,RESIDENTIAL COMMON AREA",
      "ROBBERY,DWELLING", "ROBBERY,POCKETBOOK/CARRIED BAG", 
      "ROBBERY,BEGIN AS SHOPLIFTING", "ROBBERY,HOME INVASION", 
      "ROBBERY,NECKCHAIN/JEWELRY", "ROBBERY,PUBLIC PLACE INSIDE", 
      "ROBBERY,BICYCLE", "ROBBERY,CLOTHING", "ROBBERY,CAR JACKING", 
      "ROBBERY,ATM LOCATION") ~ "12A Personal Robbery",
    NIBRS_Offense_Code == "120" ~ "12B Commercial Robbery",
    
    # all other crimes
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  {
    if (sum(is.na(.$NIBRS_Offense_Type)) > 0) {
      cat(" ", sum(is.na(.$NIBRS_Offense_Type)), 
          "cases could not be matched to NIBRS categories\n")
      filter(., is.na(.$NIBRS_Offense_Type)) %>% 
        group_by(OFNS_DESC, PD_DESC, Date.Year) %>% 
        summarise(n = n()) %>% 
        spread(Date.Year, n) %>% 
        write_csv("../crime_categories/categories_NYC_failures.csv")
    } else {
      cat("  All cases matched to NIBRS categories\n")
    }
    .
  } %>% 
  save_city_data("New York") %>% 
  glimpse()
```


# San Francisco

```{r}
read_csv('../original_data/San Francisco 2003 to date.csv', col_types = cols(
  .default = col_character(),
  IncidntNum = col_integer(),
  X = col_double(),
  Y = col_double(),
  PdId = col_double()
)) %>% 
  rename(Longitude = X, Latitude = Y) %>% 
  mutate(Date = paste(Date, Time)) %>% 
  add_date_var("Date", "mdY R", "America/Los_Angeles") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(read_csv("../crime_categories/categories_SF.csv"), 
            by = c('Category', 'Descript')) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    # burglary
    NIBRS_Offense_Code == "220" & Descript %in% c(
      "BURGLARY OF STORE, UNLAWFUL ENTRY", 
      "BURGLARY,STORE UNDER CONSTRUCTION, FORCIBLE ENTRY", 
      "BURGLARY,STORE UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY OF STORE, FORCIBLE ENTRY",
      "BURGLARY OF HOTEL ROOM, UNLAWFUL ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, FORCIBLE ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, UNLAWFUL ENTRY",
      "BURGLARY,STORE UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY OF STORE, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY OF WAREHOUSE, FORCIBLE ENTRY", 
      "BURGLARY OF WAREHOUSE, UNLAWFUL ENTRY",
      "BURGLARY OF HOTEL ROOM, FORCIBLE ENTRY", "SAFE BURGLARY OF A STORE", 
      "BURGLARY,APT UNDER CONSTRUCTION, UNLAWFUL ENTRY", "SAFE BURGLARY",
      "BURGLARY,APT UNDER CONSTRUCTION, FORCIBLE ENTRY", 
      "BURGLARY,FLAT UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,FLAT UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, ATT. FORCIBLE",
      "BURGLARY OF WAREHOUSE, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY,HOTEL UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY OF HOTEL ROOM, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, FORCIBLE ENTRY",
      "BURGLARY,HOTEL UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,APT UNDER CONSTRUCTION, ATT. FORCIBLE", 
      "SAFE BURGLARY OF A HOTEL", "SAFE BURGLARY OF A WAREHOUSE",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, UNLAWFUL ENTRY",
      "BURGLARY,FLAT UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, ATT. FORCIBLE",
      "SAFE BURGLARY OF A WAREHOUSE WITH EXPLOSIVES",
      "SAFE BURGLARY WITH EXPLOSIVES", 
      "BURGLARY,HOTEL UNDER CONSTRUCTION, ATT. FORCIBLE") ~ 
      "22B Non-domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ "22A Domestic Burglary/Breaking & Entering",
    
    # robbery
    NIBRS_Offense_Code == "120" & Descript %in% c(
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT, STRONGARM", 
      "ROBBERY OF A CHAIN STORE WITH BODILY FORCE", 
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT WITH A GUN", 
      "ROBBERY OF A CHAIN STORE WITH A GUN",
      "ROBBERY OF A BANK WITH BODILY FORCE", "ROBBERY OF A BANK WITH A GUN", 
      "SHOPLIFTING, FORCE AGAINST AGENT", 
      "ROBBERY OF A CHAIN STORE WITH A DANGEROUS WEAPON",
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT W/ A KNIFE",
      "ROBBERY OF A SERVICE STATION WITH A GUN",
      "ROBBERY OF A BANK WITH A DANGEROUS WEAPON", 
      "ATTEMPTED ROBBERY COMM. ESTAB. WITH BODILY FORCE",
      "ROBBERY OF A CHAIN STORE WITH A KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH BODILY FORCE",
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT W/ WEAPON",
      "ATTEMPTED ROBBERY COMM. ESTABLISHMENT WITH A GUN",
      "ATTEMPTED ROBBERY COMM. ESTAB. WITH DEADLY WEAPON",
      "ROBBERY OF A SERVICE STATION WITH BODILY FORCE",
      "ATTEMPTED ROBBERY OF A BANK WITH BODILY FORCE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH A GUN",
      "ATTEMPTED ROBBERY OF A BANK WITH A DEADLY WEAPON",
      "ATTEMPTED ROBBERY COMM. ESTABLISHMENT W/KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH DEADLY WEAPON",
      "ATTEMPTED ROBBERY OF A BANK WITH A GUN",
      "ROBBERY OF A SERVICE STATION W/DANGEROUS WEAPON",
      "ROBBERY OF A SERVICE STATION WITH A KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH A KNIFE",
      "ATTEMPTED ROBBERY SERVICE STATION WITH A GUN",
      "ATTEMPTED ROBBERY SERVICE STATION W/BODILY FORCE",
      "ROBBERY OF A BANK WITH A KNIFE", 
      "ATTEMPTED ROBBERY OF A BANK WITH A KNIFE", 
      "ATTEMPTED ROBBERY SERVICE STATION WITH A KNIFE",
      "ATTEMPTED ROBBERY SERVICE STATION W/DEADLY WEAPON",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ FORCE",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ GUN",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ OTHER WEAPON",
      "ASSAULT TO ROB BANK WITH A GUN",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ KNIFE") ~ "12B Commercial Robbery",
    NIBRS_Offense_Code == "120" ~ "12A Personal Robbery",
    
    # all other crimes
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  {
    if (sum(is.na(.$NIBRS_Offense_Type)) > 0) {
      cat(" ", sum(is.na(.$NIBRS_Offense_Type)), 
          "cases could not be matched to NIBRS categories\n")
      filter(., is.na(.$NIBRS_Offense_Type)) %>% 
        group_by(Category, Descript, Date.Year) %>% 
        summarise(n = n()) %>% 
        spread(Date.Year, n) %>% 
        write_csv("../crime_categories/categories_SF_failures.csv")
    } else {
      cat("  All cases matched to NIBRS categories\n")
    }
    .
  } %>% 
  save_city_data("San Francisco") %>% 
  glimpse()
```


# Seattle

Data are from https://data.seattle.gov/Public-Safety/Seattle-Police-Department-Police-Report-Incident/7ais-f98f

```{r}
# %m/%d/%Y %I:%M:%S %p
read_csv("../original_data/Seattle 2008 to date.csv", col_types = cols(
  .default = col_character(),
  `RMS CDW ID` = col_integer(),
  `General Offense Number` = col_integer(),
  `Offense Code Extension` = col_integer(),
  Longitude = col_double(),
  Latitude = col_double(),
  Month = col_integer(),
  Year = col_integer()
), n_max = 1000) %>% 
  # since Seattle includes both start and end dates, so we will process the 
  # dates manually rather than using add_date_var()
  mutate(
    Date.Start.Temp = parse_date_time(`Occurred Date or Date Range Start`, 
                                      "mdY T", tz = "America/Los_Angeles"),
    Date.End.Temp = parse_date_time(`Occurred Date Range End`, "mdY T", 
                                    tz = "America/Los_Angeles"),
    Date.Temp = strftime(Date.Start.Temp + ((Date.End.Temp - Date.Start.Temp)/2), 
                         format = '%Y-%m-%d %H:%M', tz = "America/Los_Angeles"),
    Date.Year = year(Date.End.Temp),
    Date.Start = strftime(Date.Start.Temp, format = '%Y-%m-%d %H:%M', 
                          tz = "America/Los_Angeles"),
    Date.End = strftime(Date.End.Temp, format = '%Y-%m-%d %H:%M', 
                        tz = "America/Los_Angeles"),
    Date.Single = strftime(Date.Temp, format = '%Y-%m-%d %H:%M', 
                           tz = "America/Los_Angeles"),
    Multiple.Dates = TRUE
  ) %>% select(-Date.Start.Temp, -Date.End.Temp, -Date.Temp) %>% 
  # filter by year
  filter_by_year(2008, yearLast) %>% 
  # add crime categories
  left_join(read_csv("../crime_categories/categories_Seattle.csv"), 
            by = c("Summarized Offense Description", "Offense Type")) %>% 
  # save data
  save_city_data("Seattle") %>% 
  glimpse()
```


# Tucson

Data are from http://gisdata.tucsonaz.gov/datasets?group_ids=b6a49faa168647d8b56e1a06bd53600f&page=2&sort=name&t=police in invidiual files for each year from 2009. The variable names are
not consistent across years, so some adjustment is required before rows are
bound together. Columns are in a different order in some files, so `row_bind()`
is used to bind by column names.

The 2016 CSV file does not include co-ordinates, so first we must convert the
alternative shapefile format available on the website to the same CSV format as
the other files.

```{r}
# Specifying GEOMETRY=AS_XY here creates two columns in the output CSV file
# named X and Y, which conveniently is the name for the co-ordinate columns in
# the CSV files from other years. To avoid duplicate column names, we first
# remove the existing X and Y columns, which in any case are empty.
st_read("../original_data/Incidents_2016__Tucson_Police_Department.shp") %>% 
  select(-X, -Y) %>% 
  st_write("../original_data/Tucson 2016.csv", 
           layer_options = "GEOMETRY=AS_XY")
```

It seems to take some time for Tuscon to post annual files, but there is also a
current Incidents file that covers the past 18 months. We can use this to get
data for 2017, but must first filter out data that would otherwise duplicate
records held in the 2016 file.

```{r}
read_csv("../original_data/Incidents__Tucson_Police_Department.csv") %>% 
  filter(year(DATE_OCCU) == 2017) %>% 
  arrange(DATE_OCCU) %>% 
  write_csv("../original_data/Tucson 2017.csv", na = "")
```


```{r}
tucson_data <- dir(path = "../original_data", pattern = '^Tucson*', 
    full.names = TRUE) %>% 
  # map(function (x) {
  #   read_csv(x, n_max = 10) %>% 
  #     spec() %>% 
  #     { tibble(var = names(.$cols), present = TRUE) }
  # }) %>% reduce(left_join, by = "var")
  map(function (x) {
    
    # read data
    y <- read_csv(x, col_types = cols(.default = col_character())) %>% 
      rename(Longitude = X, Latitude = Y) %>% 
      mutate_at(vars(c("Longitude", "Latitude")), as.numeric)
    
    # harmonise inconsistently named variables
    if ("ADDRRESS_PUBLIC" %in% names(y)) {
      y <- y %>% rename(ADDRESS_PUBLIC = ADDRRESS_PUBLIC)
    } else if ("ADDRESS_PU" %in% names(y)) {
      y <- y %>% rename(ADDRESS_PUBLIC = ADDRESS_PU)
    }
    if ("WEAPON1DES" %in% names(y)) {
      y <- y %>% rename(WEAPON1DESC = WEAPON1DES)
    }
    
    # Transform co-ordinates if not in WGS84 (i.e. if the co-ordinates are so
    # much larger than is possible for Lat/Lon pairs that it can't be due to
    # rounding errors or similar). This code creates an SF object from the
    # existing tibble, transforms it, extracts the transformed co-ordinates and
    # converts the SF object back to a tibble. The custom CRS is taken from the
    # shapefile used to obtain the 2016 data (see above).
    if (max(y$Longitude, na.rm = TRUE) > 180*2) {
      y <- y %>% 
        # sf_as_sf() doesn't allow missing values, so we must first remove any
        # rows that don't have co-ordinates
        filter(!is.na(Longitude) & !is.na(Latitude)) %>% 
        st_as_sf(coords = c("Longitude", "Latitude"), 
        crs = "+proj=tmerc +lat_0=31 +lon_0=-111.9166666666667 +k=0.9999 +x_0=213360 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=ft +no_defs") %>% 
        st_transform(4326) %>% 
        mutate(
          Longitude = sapply(st_geometry(.), function (x) x[[1]]), 
          Latitude = sapply(st_geometry(.), function (x) x[[2]])
        ) %>% 
        st_set_geometry(NULL)
    }
    
    # return data
    y
    
  }) %>% 
  bind_rows() %>%
  # The field STATUTDESC has triple quotes around it in the CSV file, only two
  # pairs of which are removed by read_csv, so the remainder are removed here
  mutate(
    STATUTDESC = str_remove_all(STATUTDESC, "\""),
    date_occurred = paste(parse_date(DATE_OCCU, format = "%Y-%m-%d%.%H:%M:%S%+"), 
                      HOUR_OCCU)
  ) %>%
  add_date_var("date_occurred", "Ymd HM", "America/Phoenix") %>%
  # Since we added a variable holding the combined date and time as a string, we 
  # will remove it again to avoid keeping unnecessary variables.
  select(-date_occurred) %>% 
  filter_by_year(2009, yearLast) %>% 
  # A few crimes have no offence category listed. We will remove these now to
  # make joining the NIBRS variables easier.
  filter(!is.na(STATUTDESC)) %>% 
  # join NIBRS categories
  left_join(read_csv("../crime_categories/categories_Tucson.csv"), 
            by = 'STATUTDESC') %>% 
  save_city_data("Tucson") %>% 
  glimpse()
```


# Virginia Beach

Data are from https://data.vbgov.com/Public-Safety/Police-Incident-Reports/iqkq-gr5p

```{r}
read_csv("../original_data/Virginia Beach time period to be checked.csv") %>% 
  mutate(
    Address = str_extract(Location, '.*\\n') %>% trimws(),
    Location = str_replace(Location, "\\((.+?)\\)", "\\1")
  ) %>% 
  separate(Location, c("Latitude", "Longitude"), ", ") %>% 
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>% 
  add_date_var("Date Occured", "mdY T", "America/New_York") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(read_csv("../crime_categories/categories_VB.csv"), 
            by = 'Offense Code') %>% 
  mutate(NIBRS_Offense_Type = case_when(
    NIBRS_Offense_Code == "220" & `Offense Code` == "220A" ~ 
      "22A Domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" & `Offense Code` == "220B" ~ 
      "22B Non-domestic Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "120" ~ "12U Other Robbery",
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Domestic Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-domestic Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  {
    if (sum(is.na(.$NIBRS_Offense_Type)) > 0) {
      cat(" ", sum(is.na(.$NIBRS_Offense_Type)), 
          "cases could not be matched to NIBRS categories\n")
      filter(., is.na(.$NIBRS_Offense_Type)) %>% 
        group_by(Category, Descript, Date.Year) %>% 
        summarise(n = n()) %>% 
        spread(Date.Year, n) %>% 
        write_csv("../crime_categories/categories_VB_failures.csv")
    } else {
      cat("  All cases matched to NIBRS categories\n")
    }
    .
  } %>% 
  save_city_data("Virginia Beach") %>% 
  glimpse()
 ```

