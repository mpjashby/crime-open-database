---
title: "Process city-specific data"
output: html_notebook
---


The code in this file loads crime data from different cities in whatever format
is provided, and converts it into a common format that can be joined together.
Once processed, data from each city are saved to a temporary file to minimise
memory usage. Temporary files are in .Rds format because it is likely to be
[smaller than a zipped CSV](https://csgillespie.github.io/efficientR/efficient-inputoutput.html#efficient-data-export-.rdata-or-.rds).


# Cities included

The initial exploratory analysis identified these cities as having published 
geocoded data with reasonable crime categories since at least January 2013 
(giving four years of data as of December 2016):

 * Chicago
 * Detroit
 * Fort Worth
 * Los Angeles
 * Louisville
 * New York City
 * San Francisco
 * Tucson
 * Virginia Beach

Note: 

 * Boston is ommitted because the offence categories used are in many cases 
   (e.g. fraud, larceny) too broad to be mapped to NIBRS
 * Kansas City, MO, is not on the list because some crimes are geocoded to 
   places outside the city boundary and it's not obvious what the reason is
 * Minneapolis is not on the list because there is no field from which NIBRS 
   categories can be generated
 * New Orleans is ommitted because some offences are spread across (many) 
   multiple records
 * Raleigh is not on the list because lots of offences (including all those 
   committed by juveniles) are ommitted
   

# Chicago

```{r}
read_csv('../original_data/Chicago 2001 to date.csv') %>% 
  rename(Address = Block) %>% 
  # add date variable
  add_date_var("Date", "mdY T", "America/Chicago") %>% 
  # filter by year
  filter_by_year(yearFirst, yearLast) %>% 
  # add crime categories
  join_nibrs_cats("../crime_categories/categories_Chicago.csv",
                  by = c("Primary Type", "Description")) %>% 
  # left_join(read_csv("../crime_categories/categories_Chicago.csv"), 
  #           by = c("Primary Type", "Description")) %>% 
  # separate burglaries and robberies into sub-categories
  mutate(NIBRS_Offense_Type = case_when(
    # residential burglary
    # CONSIDER ADDING "HOTEL/MOTEL", "RESIDENTIAL YARD (FRONT/BACK)", 
    # "BOAT/WATERCRAFT", "DRIVEWAY - RESIDENTIAL"
    NIBRS_Offense_Code == "220" & `Location Description` %in% c("RESIDENCE", 
      "APARTMENT", "RESIDENCE-GARAGE", "CHA APARTMENT", 
      "RESIDENCE PORCH/HALLWAY", "NURSING HOME/RETIREMENT HOME", 
      "COLLEGE/UNIVERSITY RESIDENCE HALL") ~ 
      "22A Residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "120" & `Location Description` %in% 
      c("SMALL RETAIL STORE", "GAS STATION", "RESTAURANT", 
        "GROCERY FOOD STORE", "BANK", "CONVENIENCE STORE", "DEPARTMENT STORE", 
        "DRUG STORE", "TAVERN/LIQUOR STORE", "BARBERSHOP", "CURRENCY EXCHANGE", 
        "CLEANING STORE", "BAR OR TAVERN", "COMMERCIAL / BUSINESS OFFICE", 
        "CAR WASH", "VEHICLE-COMMERCIAL", "CONSTRUCTION SITE", 
        "POLICE FACILITY/VEH PARKING LOT", "CHURCH/SYNAGOGUE/PLACE OF WORSHIP", 
        "WAREHOUSE", "DELIVERY TRUCK", "FACTORY/MANUFACTURING BUILDING", 
        "GOVERNMENT BUILDING/PROPERTY", "APPLIANCE STORE", 
        "MEDICAL/DENTAL OFFICE", "MOVIE HOUSE/THEATER", "PAWN SHOP", 
        "SAVINGS AND LOAN", "NEWSSTAND", "POOL ROOM", 
        "AIRPORT BUILDING NON-TERMINAL - NON-SECURE AREA", "CREDIT UNION", 
        "BOWLING ALLEY", "VEHICLE - DELIVERY TRUCK") ~ "12B Commercial Robbery",
    NIBRS_Offense_Code == "120" & `Location Description` == "OTHER" ~ 
      "12U Other Robbery",
    NIBRS_Offense_Code == "120" ~ "12A Personal Robbery",
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  # identify location types
  left_join(
    read_csv("../crime_categories/location_types_chicago.csv", 
             col_types = cols(.default = col_character())),
    by = "Location Description"
  ) %>% 
  # save data
  save_city_data("Chicago") %>% 
  glimpse()
```


# Detroit

Detroit data changed format at the end of 2016. Although the column names 
changed, the information provided in the two files is largely the same. Offences
occurring on 6 December 2016 can appear in either file, but do not appear to be
duplicated. The newer file contains far fewer records overall, but this is
because of a substantial reduction in non-criminal incidents recorded in the 
later file. There are, however, some differences in the categorisations:

  * 11A Rape (except Statutory Rape), 11C Sexual Assault With An Object, 
    11D Fondling, 36B Statutory Rape and 40A Prostitution only appear in the new 
    file.
  * There is a large decrease in crimes in 13C Intimidation and 210 
    Extortion/Blackmail in 2017, for which there is no obvious cause.
  * In the new file, commercial and personal robbery can no longer be 
    distinguished, so almost all robberies are coded as 12U Other Robbery.
    Similarly it is no longer possible to distinguish between residential and
    non-residential burglary, so all burglaries from 2017 onwards are classified 
    as 22U Other Burglary/Breaking & Entering.
  * There are large increases in 26B Credit Card/Automated Teller Machine Fraud
    and 26E Wire Fraud together with an even larger decreases in 26A 
    False Pretenses/Swindle/Confidence Game and 270 Embezzlement.
  * There is a large increase in 90F Family Offenses, Nonviolent offences.

Detroit data also do not include a location-type field.

```{r}
list(
  read_csv("../original_data/Detroit 2009 to 2016.csv", 
           col_types = cols(.default = col_character())) %>%
    select(-ROWNUM, -CASEID, -CENSUSTRACT) %>% 
    separate(LOCATION, into = c("Incident Address", "LOCATION"), sep = "\\n") %>% 
    mutate(
      HOUR = paste0(str_pad(HOUR, width = 2, side = "left", pad = "0"), "00"),
      SCA = str_pad(SCA, width = 4, side = "left", pad = "0"),
      PRECINCT = str_pad(PRECINCT, width = 2, side = "left", pad = "0"),
      COUNCIL = str_remove(COUNCIL, "City Council District ")
    ),
  read_csv("../original_data/Detroit 2016 to date.csv", 
           col_types = cols(.default = col_character())) %>% 
    select(-`Day of Week (Sunday is 1)`, -`Hour of Day`,
           -Year, -`Census Block GEOID`, -Longitude, -Latitude, -`Zip Code`) %>% 
    rename(
      CRIMEID = `Crime ID`,
      CRNO = `Report #`,
      OFFENSEDESCRIPTION = `Offense Description`,
      CATEGORY = `Offense Category`,
      STATEOFFENSEFILECLASS = `State Offense Code`,
      INCIDENTDATE = `Incident Date & Time`,
      HOUR = `Incident Time (24h)`,
      SCA = `Scout Car Area`,
      PRECINCT = `Precinct Number`,
      LOCATION = `Location`,
      NEIGHBORHOOD = `Neighborhood`,
      COUNCIL = `Council District`
    ) %>% 
    mutate(
      NEIGHBORHOOD = str_to_upper(NEIGHBORHOOD),
      LOCATION = str_remove(LOCATION, "^location\\n"),
      `Incident Address` = str_remove_all(`Incident Address`, "block of ")
    )
) %>% 
  bind_rows() %>% 
  mutate(
    LOCATION = str_replace(LOCATION, ".*\\((.+)\\)", "\\1"),
    INCIDENTDATE = paste(parse_date(INCIDENTDATE, "%m/%d/%Y %I:%M:%S %p"), HOUR)
  ) %>% 
  separate(LOCATION, c("Latitude", "Longitude"), ", ") %>% 
  add_date_var("INCIDENTDATE", "Ymd R", "America/Detroit") %>%
  filter_by_year(2009, yearLast) %>% 
  join_nibrs_cats("../crime_categories/categories_Detroit.csv", 
            by = c("CATEGORY", "OFFENSEDESCRIPTION")) %>% 
  # left_join(read_csv("../crime_categories/categories_Detroit.csv"), 
  #           by = c("CATEGORY", "OFFENSEDESCRIPTION")) %>% 
  save_city_data("Detroit") %>% 
  glimpse()
  # filter(is.na(NIBRS_Offense_Category)) %>% 
  # group_by(Date.Year, NIBRS_Offense_Type) %>% 
  # summarise(n = n()) %>% 
  # spread(Date.Year, n) %>% 
  # arrange(NIBRS_Offense_Type) %>% 
  # View()
  # write_csv("../crime_categories/categories_Detroit_temp.csv")
  # mutate(month = month(Date.Single)) %>% 
  # group_by(Date.Year, month) %>%
  # summarise(n = n()) %>% 
  # spread(month, n)
```


# Fort Worth

Data are from https://data.fortworthtexas.gov/Public-Safety/Crime-Data/k6ic-7kp7

The `Offense` column seems to contain NIBRS codes, so it's just necessary to 
match the codes to the offence categories. This can be done directly by using 
the look-up table, so there is no need to create a mapping between local offence 
codes and NIBRS codes as there is for other cities.

```{r}
read_csv('../original_data/Fort Worth time period to be checked.csv', 
         col_types = cols(
           .default = col_character(),
           `Case Number` = col_integer(),
           `Council District` = col_integer(),
           `Location Type` = col_integer()
         )) %>% 
  mutate(
    Location = str_replace(Location, ".*\\((.+)\\)", "\\1")
  ) %>% 
  separate(Location, c("Latitude", "Longitude"), ", ") %>% 
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>% 
  add_date_var("From Date", 'mdY T', "America/Chicago") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  left_join(nibrs_categories, by = "Offense") %>%
  mutate(NIBRS_Offense_Type = case_when(
    NIBRS_Offense_Code == "220" & `Location Description` == "Residence, home" ~ 
      "22A Residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "120" & `Location Description` %in% c(
      "Highway, street, roadway, alley", "Parking lot, garage", 
      "Residence, home", "Field, woods", "Park/Playground", 
      "Airplane, bus, train terminal", "School, college", "Shopping Mall",
      "Lake, waterway", "School-Elementary/Secondary", "ATM separate from Bank",
      "Rest Area", "School-College/University") ~ "12A Personal Robbery",
    NIBRS_Offense_Code == "120" & `Location Description` == "Other, unknown" ~ 
      "12U Other Robbery",
    NIBRS_Offense_Code == "120" ~ "12B Commercial Robbery",
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  # identify location types
  left_join(
    read_csv("../crime_categories/location_types_fort_worth.csv", 
             col_types = cols(.default = col_character())),
    by = "Location Description"
  ) %>% 
  save_city_data("Fort Worth") %>% 
  glimpse()
```


# Los Angeles

LA data include multiple offences occurring during the same incident in a single 
row, so to make them equivalent to the other cities these data should be 
converted from long to wide.

Most categories can be extracted from the `Crime Code Description` field, but 
for some offences it may be necessary to look at the MO used, as coded in the 
`MO Codes` field. The `MO Codes` field is a space-separated list of codes, 
meaning a lookup table can't be created as for other cities. As such, to 
generate the NIBRS for LA data, we need to:

  1. use the `Crime Code Description` field and -- where necessary -- the 
     `MO Codes` field to allocate a NIBRS category to each record, then
  2. use that NIBRS category to match all the other NIBRS columns.

```{r}
read_csv('../original_data/Los Angeles 2010 to date.csv', 
         col_types = cols(
           .default = col_character(),
           `Crime Code` = col_integer(),
           `Victim Age` = col_integer(),
           `Premise Code` = col_integer(),
           `Weapon Used Code` = col_integer(),
           `Crime Code 1` = col_integer(),
           `Crime Code 2` = col_integer(),
           `Crime Code 3` = col_integer(),
           `Crime Code 4` = col_integer()
         )) %>% 
# convert from wide to long
# This code converts the four crime-code fields into wide format while 
# duplicating all the other columns across each new row. The `gather` function 
# requires that all variables to be left alone be specified, so a `setdiff` 
# function is used to return all the variables that are not one of the 
# crime-code fields.
  gather(
    WhichCrime, 
    CrimeType, 
    `Crime Code 1`, 
    `Crime Code 2`, 
    `Crime Code 3`, 
    `Crime Code 4`, 
    -one_of(setdiff(
      names(.), 
      c('Crime Code 1', 'Crime Code 2', 'Crime Code 3', 'Crime Code 4')
    )), 
    na.rm = TRUE) %>% 
  mutate(
    Location = str_replace(Location, "\\((.+?)\\)", "\\1"),
    `Date Occurred` = paste(`Date Occurred`, `Time Occurred`)
  ) %>% 
  separate(Location, c("Latitude", "Longitude"), ", ") %>% 
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>% 
  add_date_var("Date Occurred", "mdY R", "America/Los_Angeles") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  mutate(
    # convert empty `MO Codes` fields from NA to an empty string, which makes it 
    # easier to search that field later
    `MO Codes` = if_else(is.na(`MO Codes`), "", `MO Codes`),
    NIBRS_Offense_Type = case_when(

      # Arson
      `Crime Code Description` %in% c('ARSON') ~ '200 Arson',
      
      # Assault
      `Crime Code Description` %in% c(
        'ASSAULT WITH DEADLY WEAPON ON POLICE OFFICER', 
        'ASSAULT WITH DEADLY WEAPON, AGGRAVATED ASSAULT', 
        'INTIMATE PARTNER - AGGRAVATED ASSAULT', 
        'CHILD ABUSE (PHYSICAL) - AGGRAVATED ASSAULT') ~ 
        '13A Aggravated assault',
      `Crime Code Description` %in% c(
        'BATTERY - SIMPLE ASSAULT', 'BATTERY ON A FIREFIGHTER', 
        'BATTERY POLICE (SIMPLE)', 'INTIMATE PARTNER - SIMPLE ASSAULT', 
        'OTHER ASSAULT', 'CHILD ABUSE (PHYSICAL) - SIMPLE ASSAULT', 
        'RESISTING ARREST') ~ '13B Simple assault',
      `Crime Code Description` %in% c('CRIMINAL THREATS - NO WEAPON DISPLAYED', 
        'STALKING', 'BOMB SCARE', 'THREATENING PHONE CALLS/LETTERS',
        "LETTERS, LEWD  -  TELEPHONE CALLS, LEWD") ~ 
        '13C Intimidation',
      
      # Bribery
      `Crime Code Description` %in% c('BRIBERY') ~ '510 Bribery',
      
      # Burglary/Breaking & Entering
      `Crime Code Description` %in% c('BURGLARY', 'BURGLARY, ATTEMPTED') &
        `Premise Description` %in% c("SINGLE FAMILY DWELLING", 
          "MULTI-UNIT DWELLING (APARTMENT, DUPLEX, ETC)", "GARAGE/CARPORT", 
          "OTHER RESIDENCE", "CONDOMINIUM/TOWNHOUSE", 
          "MOBILE HOME/TRAILERS/CONSTRUCTION TRAILERS/RV'S/MOTORHOME", 
          "NURSING/CONVALESCENT/RETIREMENT HOME", 
          "FRAT HOUSE/SORORITY/DORMITORY", "PROJECT/TENEMENT/PUBLIC HOUSING", 
          "GROUP HOME", "PORCH, RESIDENTIAL", "FOSTER HOME BOYS OR GIRLS*") ~ 
        "22A Residential Burglary/Breaking & Entering",
      `Crime Code Description` %in% c('BURGLARY', 'BURGLARY, ATTEMPTED') ~ 
        "22B Non-residential Burglary/Breaking & Entering",

      # Counterfeiting/Forgery
      `Crime Code Description` %in% c('COUNTERFEIT', 
        'DOCUMENT FORGERY / STOLEN FELONY') ~ '250 Counterfeiting/Forgery',
      
      # Destruction/Damage/Vandalism of Property (except Arson)
      `Crime Code Description` %in% c(
        'VANDALISM - FELONY ($400 & OVER, ALL CHURCH VANDALISMS) 0114', 
        'VANDALISM - MISDEAMEANOR ($399 OR UNDER)', 
        'TELEPHONE PROPERTY - DAMAGE', "TRAIN WRECKING", 
        "VANDALISM - FELONY ($400 & OVER, ALL CHURCH VANDALISMS)") ~ 
        '290 Destruction/Damage/Vandalism of Property (except Arson)',
      
      # Embezzlement
      `Crime Code Description` %in% c(
        'EMBEZZLEMENT, GRAND THEFT ($950.01 & OVER)', 
        'EMBEZZLEMENT, PETTY THEFT ($950 & UNDER)', 
        'DISHONEST EMPLOYEE - GRAND THEFT', 'DISHONEST EMPLOYEE - PETTY THEFT', 
        'DISHONEST EMPLOYEE ATTEMPTED THEFT') ~ '270 Embezzlement',
      
      # Extortion/Blackmail
      `Crime Code Description` %in% c('EXTORTION') ~ '210 Extortion/Blackmail',
      
      # Fraud Offenses (except Counterfeiting/Forgery and Bad Checks)
      `Crime Code Description` %in% c(
        'DEFRAUDING INNKEEPER/THEFT OF SERVICES, $400 & UNDER', 
        'DEFRAUDING INNKEEPER/THEFT OF SERVICES, OVER $400', 'BUNCO, ATTEMPT', 
        'BUNCO, GRAND THEFT', 'BUNCO, PETTY THEFT', 
        'GRAND THEFT / INSURANCE FRAUD') ~ 
        '26A False Pretenses/Swindle/Confidence Game',
      `Crime Code Description` %in% c('CREDIT CARDS, FRAUD USE ($950 & UNDER', 
        'CREDIT CARDS, FRAUD USE ($950.01 & OVER)') ~ 
        '26B Credit Card/Automated Teller Machine Fraud',
      `Crime Code Description` %in% c('THEFT OF IDENTITY') ~ 
        '26C Impersonation',
      `Crime Code Description` %in% c('UNAUTHORIZED COMPUTER ACCESS') ~ 
        '26E Wire Fraud',
      
      # Homicide Offenses
      `Crime Code Description` %in% c('CRIMINAL HOMICIDE') ~ 
        '09A Murder and Nonnegligent Manslaughter',
      `Crime Code Description` %in% c('MANSLAUGHTER, NEGLIGENT') ~ 
        '09B Negligent Manslaughter',
      
      # Kidnapping/Abduction
      `Crime Code Description` %in% c('CHILD STEALING', 'FALSE IMPRISONMENT', 
        'KIDNAPPING', 'KIDNAPPING - GRAND ATTEMPT') ~ 
        '100 Kidnapping/Abduction',
      
      # Larceny/Theft Offenses
      `Crime Code Description` %in% c('PICKPOCKET', 'PICKPOCKET, ATTEMPT', 
        'DRUNK ROLL', 'DRUNK ROLL - ATTEMPT') ~ '23A Pocket-picking',
      `Crime Code Description` %in% c('PURSE SNATCHING', 
        'PURSE SNATCHING - ATTEMPT') ~ '23B Purse-snatching',
      `Crime Code Description` %in% c('SHOPLIFTING - ATTEMPT', 
        'SHOPLIFTING - PETTY THEFT ($950 & UNDER)', 
        'SHOPLIFTING-GRAND THEFT ($950.01 & OVER)') ~ '23C Shoplifting',
      `Crime Code Description` %in% c('TILL TAP - ATTEMPT', 
        'TILL TAP - GRAND THEFT ($950.01 & OVER)', 
        'TILL TAP - PETTY ($950 & UNDER)') ~ '23D Theft From Building',
      `Crime Code Description` %in% c('THEFT, COIN MACHINE - ATTEMPT', 
        'THEFT, COIN MACHINE - GRAND ($950.01 & OVER)', 
        'THEFT, COIN MACHINE - PETTY ($950 & UNDER)') ~ 
        '23E Theft From Coin-Operated Machine or Device',
      `Crime Code Description` %in% c('THEFT FROM MOTOR VEHICLE - ATTEMPT', 
        'THEFT FROM MOTOR VEHICLE - GRAND ($400 AND OVER)', 
        'THEFT FROM MOTOR VEHICLE - PETTY ($950 & UNDER)', 
        'BURGLARY FROM VEHICLE', 'BURGLARY FROM VEHICLE, ATTEMPTED') ~ 
        '23F Theft From Motor Vehicle (except Theft of Motor Vehicle Parts or Accessories)',
      `Crime Code Description` %in% c('THEFT PLAIN - ATTEMPT', 
        'THEFT PLAIN - PETTY ($950 & UNDER)', 
        'THEFT-GRAND ($950.01 & OVER)EXCPT,GUNS,FOWL,LIVESTK,PROD0036', 
        'BIKE - ATTEMPTED STOLEN', 'BIKE - STOLEN', 'BOAT - STOLEN', 
        'GRAND THEFT / AUTO REPAIR', 'PETTY THEFT - AUTO REPAIR', 
        'THEFT, PERSON', 'THEFT FROM PERSON - ATTEMPT', 
        "THEFT-GRAND ($950.01 & OVER)EXCPT,GUNS,FOWL,LIVESTK,PROD") ~ 
        '23H All Other Larceny',
      # some 23A and 23B offences are coded using a combination of crime codes 
      # and MO codes, so have to be done after the other larceny categories are 
      # created
      `Crime Code Description` %in% c('THEFT, PERSON', 
        'THEFT FROM PERSON - ATTEMPT') & 
        str_count(`MO Codes`, pattern = '0357') > 0 ~ '23A Pocket-picking',
      `Crime Code Description` %in% c('THEFT, PERSON', 
        'THEFT FROM PERSON - ATTEMPT') & str_count(`MO Codes`, 
          pattern = '0336|0337|0341|0342|0343|0346|0355') > 0 ~ 
        '23B Purse-snatching',
      # 23G offences are identified using an MO code that can be present in 
      # several crime categories, so this assignment has to be done after all 
      # the other theft categories are created
      `Crime Code Description` %in% c('BURGLARY FROM VEHICLE', 
        'BURGLARY FROM VEHICLE, ATTEMPTED', 'THEFT FROM MOTOR VEHICLE - ATTEMPT', 
        'THEFT FROM MOTOR VEHICLE - GRAND ($400 AND OVER)', 
        'THEFT FROM MOTOR VEHICLE - PETTY ($950 & UNDER)', 
        'THEFT PLAIN - ATTEMPT', 'THEFT PLAIN - PETTY ($950 & UNDER)', 
        'THEFT-GRAND ($950.01 & OVER)EXCPT,GUNS,FOWL,LIVESTK,PROD0036') & 
        str_count(`MO Codes`, pattern = '0385') > 0 ~ 
        '23G Theft of Motor Vehicle Parts or Accessories',
      
      # Motor Vehicle Theft
      `Crime Code Description` %in% c('VEHICLE - STOLEN', 
        'VEHICLE - ATTEMPT STOLEN', 'DRIVING WITHOUT OWNER CONSENT (DWOC)') ~ 
        '240 Motor Vehicle Theft',
      
      # Prostitution Offenses
      `Crime Code Description` %in% c('PIMPING') ~ 
        '40B Assisting or Promoting Prostitution',
      `Crime Code Description` %in% c('PANDERING') ~ 
        '40C Purchasing Prostitution',
      
      # Robbery
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') & 
        `Premise Description` %in% c("STREET", "SIDEWALK", "PARKING LOT", 
          "MULTI-UNIT DWELLING (APARTMENT, DUPLEX, ETC)", 
          "SINGLE FAMILY DWELLING", "MARKET", "ALLEY", "BUS STOP", 
          "PARK/PLAYGROUND", "DRIVEWAY", "HIGH SCHOOL", 
          "YARD (RESIDENTIAL/BUSINESS)", "VEHICLE, PASSENGER/TRUCK", 
          "BUS STOP OR LAYOVER", "GARAGE/CARPORT", "JUNIOR HIGH SCHOOL",
          "PARKING UNDERGROUND/BUILDING", "AUTOMATED TELLER MACHINE (ATM)",
          "BEACH", "PROJECT/TENEMENT/PUBLIC HOUSING", "OTHER RESIDENCE",
          "ELEMENTARY SCHOOL", "PORCH, RESIDENTIAL", 
          "CHARTER BUS AND PRIVATELY OWNED BUS", "FREEWAY", 
          "PUBLIC RESTROOM/OUTSIDE*", "STAIRWELL*", "MTA BUS", 
          "PUBLIC RESTROOM(INDOORS-INSIDE)", "RIVER BED*", 
          "CONDOMINIUM/TOWNHOUSE", "SKATEBOARD FACILITY/SKATEBOARD PARK*",
          "COLLEGE/JUNIOR COLLEGE/UNIVERSITY", "TRAIN", 
          "MOBILE HOME/TRAILERS/CONSTRUCTION TRAILERS/RV'S/MOTORHOME",
          "MTA PROPERTY OR PARKING LOT", "UNDERPASS/BRIDGE*", "ELEVATOR",
          "GROUP HOME", "PATIO*", "PEDESTRIAN OVERCROSSING", 
          "SPECIALTY SCHOOL/OTHER", "METROLINK TRAIN", "VACANT LOT", 
          "ABANDONED BUILDING ABANDONED HOUSE", "REDLINE ENTRANCE/EXIT",
          "TRANSPORTATION FACILITY (AIRPORT)", "BUS, SCHOOL, CHURCH",
          "TRAIN TRACKS", "TUNNEL", "OTHER RR TRAIN (UNION PAC, SANTE FE ETC",
          "PAY PHONE", "REDLINE SUBWAY PLATFORM", "TERMINAL", 
          "MUNICIPAL BUS LINE INCLUDES LADOT/DASH", 
          "POOL-PUBLIC/OUTDOOR OR INDOOR*", "PRIVATE SCHOOL/PRESCHOOL",
          "REDLINE (SUBWAY TRAIN)", "SLIPS/DOCK/MARINA/BOAT", 
          "BLUE LINE (ABOVE GROUND SURFACE TRAIN)", "FOSTER HOME BOYS OR GIRLS*",
          "FRAT HOUSE/SORORITY/DORMITORY", "GOLF COURSE*", 
          "GREEN LINE (I-105 FWY LEVEL TRAIN)") ~ "12A Personal Robbery",
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') & 
        (`Premise Description` %in% c("OTHER PREMISE", "OTHER/OUTSIDE") | 
           is.na(`Premise Description`)) ~ "12U Other Robbery",
      `Crime Code Description` %in% c('ROBBERY', 'ATTEMPTED ROBBERY') ~ 
        "12B Commercial Robbery",

      # Sex Offenses
      `Crime Code Description` %in% c('RAPE, ATTEMPTED', 'RAPE, FORCIBLE') ~ 
        '11A Rape (except Statutory Rape)',
      `Crime Code Description` %in% c('SODOMY/SEXUAL CONTACT B/W PENIS OF ONE PERS TO ANUS OTH 0007=02',
        'ORAL COPULATION') ~ '11B Sodomy',
      `Crime Code Description` %in% c('SEXUAL PENTRATION WITH A FOREIGN OBJECT') ~
        '11C Sexual Assault With An Object',
      `Crime Code Description` %in% c('BATTERY WITH SEXUAL CONTACT') ~ 
        '11D Fondling',
      
      # Sex Offenses, Nonforcible
      `Crime Code Description` %in% c('INCEST (SEXUAL ACTS BETWEEN BLOOD RELATIVES)') ~ 
        '36A Incest',
      `Crime Code Description` %in% c('SEX, UNLAWFUL') ~ '36B Statutory Rape',
      # The offence of 'CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060'
      # is problematic because it covers a wide array of behaviour. Offenses
      # matching specific criteria are allocated to particular categories, with
      # all remaining offences being allocated to category 90Z. The specific 
      # offences are ordered by decreasing severity, since an offence may match 
      # multiple MO codes.
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0527|0533') > 0 ~ '36B Statutory Rape',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0507|0512|0519|0521|0539|0540|0541|0548|0549') > 0
      ~ '11B Sodomy',
      `Crime Code Description` == "SODOMY/SEXUAL CONTACT B/W PENIS OF ONE PERS TO ANUS OTH" 
      ~ "11C Sexual Assault With An Object",
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0515') > 0 ~ 
        '11C Sexual Assault With An Object',
      `Crime Code Description` %in% c("SEX,UNLAWFUL(INC MUTUAL CONSENT, PENETRATION W/ FRGN OBJ", 
        "SEX,UNLAWFUL(INC MUTUAL CONSENT, PENETRATION W/ FRGN OBJ0059",
        "SEXUAL PENETRATION W/FOREIGN OBJECT") ~ 
        "11C Sexual Assault With An Object",
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0500|0501|0502|0503|0504|0505|0506|0509|0510|0511|0517|0518|0522|0528|0532|0537|0543|0544|0550|0551') > 0 
      ~ '11D Fondling',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      & str_count(`MO Codes`, pattern = '0529|0538') > 0 ~ 
        '90C Disorderly Conduct',
      `Crime Code Description` %in% c('CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)0060') 
      ~ '90Z All Other Offenses',
      
      # Pornography/Obscene Material
      `Crime Code Description` == "CHILD PORNOGRAPHY" ~ 
        "370 Pornography/Obscene Material",
      
      # Weapon Law Violations
      `Crime Code Description` %in% c('BRANDISH WEAPON', 
        'WEAPONS POSSESSION/BOMBING', 
        'FIREARMS EMERGENCY PROTECTIVE ORDER (FIREARMS EPO)', 
        'DISCHARGE FIREARMS/SHOTS FIRED', 
        'REPLICA FIREARMS(SALE,DISPLAY,MANUFACTURE OR DISTRIBUTE)0132', 
        'SHOTS FIRED AT INHABITED DWELLING', 
        'SHOTS FIRED AT MOVING VEHICLE, TRAIN OR AIRCRAFT', 
        "FIREARMS RESTRAINING ORDER (FIREARMS RO)",
        "REPLICA FIREARMS(SALE,DISPLAY,MANUFACTURE OR DISTRIBUTE)") ~ 
        '520 Weapon Law Violations',
      
      # Human Trafficking
      `Crime Code Description` == "HUMAN TRAFFICKING - COMMERCIAL SEX ACTS" ~ 
        "64A Human Trafficking, Commercial Sex Acts",
      `Crime Code Description` == "HUMAN TRAFFICKING - INVOLUNTARY SERVITUDE" ~ 
        "64B Human Trafficking, Involuntary Servitude",
      
      # Bad Checks (except Counterfeit Checks or Forged Checks)
      `Crime Code Description` %in% c('DOCUMENT WORTHLESS ($200 & UNDER)', 
        'DOCUMENT WORTHLESS ($200.01 & OVER)') ~ 
        '90A Bad Checks (except Counterfeit Checks or Forged Checks)',
      
      # Curfew/Loitering/Vagrancy Violations
      `Crime Code Description` %in% c('FAILURE TO DISPERSE', 
        'BLOCKING DOOR INDUCTION CENTER') ~ 
        '90B Curfew/Loitering/Vagrancy Violations',
      
      # Disorderly Conduct
      `Crime Code Description` %in% c('DISTURBING THE PEACE', 'DISRUPT SCHOOL', 
        'INCITING A RIOT', 'INDECENT EXPOSURE', 'LEWD CONDUCT', 
        'THROWING OBJECT AT MOVING VEHICLE') ~ '90C Disorderly Conduct',
      
      # Family Offenses, Nonviolent
      `Crime Code Description` %in% c('CHILD ABANDONMENT', 
        'CHILD NEGLECT (SEE 300 W.I.C.)', 
        "CRM AGNST CHLD (13 OR UNDER) (14-15 & SUSP 10 YRS OLDER)",
        "LEWD/LASCIVIOUS ACTS WITH CHILD") ~ 
        '90F Family Offenses, Nonviolent',
      
      # Peeping Tom
      `Crime Code Description` %in% c('PEEPING TOM') ~ '90H Peeping Tom',

      # Trespass of Real Property
      `Crime Code Description` %in% c('PROWLER', 'TRESPASSING') ~ 
        '90J Trespass of Real Property',
      
      # All Other Offenses
      `Crime Code Description` %in% c('ABORTION/ILLEGAL', 
        'BEASTIALITY, CRIME AGAINST NATURE SEXUAL ASSLT WITH ANIM0065', 'BIGAMY', 
        'CHILD ANNOYING (17YRS & UNDER)', 'CONSPIRACY', 'CONTEMPT OF COURT', 
        'CONTRIBUTING', 'CRUELTY TO ANIMALS', 'FALSE POLICE REPORT', 
        'ILLEGAL DUMPING', 'LYNCHING', 'LYNCHING - ATTEMPTED', 
        'VIOLATION OF COURT ORDER', 'VIOLATION OF RESTRAINING ORDER', 
        'VIOLATION OF TEMPORARY RESTRAINING ORDER', 'LETTERS, LEWD', 
        'OTHER MISCELLANEOUS CRIME') ~ '90Z All Other Offenses',
      is.na(`Crime Code Description`) ~ "90Z All Other Offenses",
      
      # Not-categorisable offences
      # Where it is clear that not all the offences that should be present are 
      # present in the data, it would be misleading to populate those 
      # categories. Offences within such categories that are present are 
      # categorised here so that they can be stripped from the analysis.
      `Crime Code Description` %in% c('DRUGS, TO A MINOR') ~ 
        '99X Non-Categorisable Offenses',

      # Non-reportable crimes
      `Crime Code Description` %in% c('FAILURE TO YIELD', 'RECKLESS DRIVING') ~
        '99Y Non-Reportable Crimes'

    )
  ) %>% 
  left_join(nibrs_categories, by = "NIBRS_Offense_Type") %>%
  check_nibrs_cats("../crime_categories/categories_LA",
                   by = "Crime Code Description") %>% 
  # join_nibrs_cats("../crime_categories/NIBRS categories.csv",
  #                 by = "NIBRS_Offense_Type") %>% 
  # sample_n(50) %>% 
  # View()
  # where necessary, update the NIBRS code to match the new type
  mutate(NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>%
  # identify location types
  left_join(
    read_csv("../crime_categories/location_types_los_angeles.csv", 
             col_types = cols(.default = col_character())),
    by = "Premise Description"
  ) %>% 
  save_city_data("Los Angeles") %>%
  glimpse()
```


# Louisville

Louisville has a field called `NIBRS_CODE` that can be used to match the various 
levels of the NIBRS hierarchy. However, some incidents that Louisville 
categorises as 90Z should actually be in other categories, e.g. because they are 
not criminal or are criminal but are not NIBRS reportable. Other crimes are 
recorded in category 999, in many cases despite a NIBRS code existing for that
offence. These need to be reallocated manually.

```{r}
dir(path = "../original_data", pattern = 'Louisville*', 
    full.names = TRUE) %>% 
  map(read_csv, col_types= cols(
    .default = col_character(),
    ID = col_integer()
  )) %>% 
  reduce(rbind) %>% 
  add_date_var("DATE_OCCURED", "Ymd T", "America/Kentucky/Louisville") %>% 
  filter_by_year(2009, yearLast) %>% 
  left_join(nibrs_categories, by = c("NIBRS_CODE" = "Offense")) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    
    # homcide
    NIBRS_CODE == "999" & UOR_DESC %in% c("FETAL HOMICIDE - 1ST DEGREE",
      "MURDER - DOMESTIC VIOLENCE") ~ 
      "09A Murder and Nonnegligent Manslaughter",
    NIBRS_CODE == "999" & UOR_DESC %in% c("RECKLESS HOMICIDE") ~ 
      "09B Negligent Manslaughter",
    
    # kidnapping
    NIBRS_CODE == "999" & UOR_DESC %in% c("UNLAWFUL IMPRISONMENT-1ST DEGREE",
      "UNLAWFUL IMPRISONMENT-2ND DEGREE", 
      "KIDNAPPING-WITH SERIOUS PHYSICAL INJURY") ~ "100 Kidnapping/Abduction",
    
    # sex offences
    # it seems to be safe to search on the word 'rape', since there aren't any
    # crimes coded as 999 and described as statutory rape
    NIBRS_CODE == "999" & str_detect(UOR_DESC, "\\bRAPE\\b") == TRUE ~ 
      "11A Rape (except Statutory Rape)",
    NIBRS_CODE == "999" & UOR_DESC %in% c("SODOMY - 1ST DEGREE",
      "SODOMY - 1ST DEGREE - DOMESTIC VIOLENCE", 
      "SODOMY - 1ST DEGREE - VICTIM U/12 YEARS OF AGE") ~ "11B Sodomy",
    NIBRS_CODE == "999" & UOR_DESC %in% c("SEXUAL ABUSE - 1ST DEGREE",
      "SEXUAL ABUSE - 1ST DEGREE- VICTIM U/12 YOA", 
      "SEXUAL ABUSE - 3RD DEGREE") ~ "11D Fondling",
    
    # robbery
    (NIBRS_CODE == "120" | str_detect(UOR_DESC, "\\bROBBERY\\b")) & 
      PREMISE_TYPE %in% c("HIGHWAY / ROAD / ALLEY", 
      "RESIDENCE / HOME", "PARKING LOT / GARAGE", 
      "OTHER RESIDENCE (APARTMENT/CONDO)", "SCHOOL - ELEMENTARY / SECONDARY", 
      "FIELD / WOODS", "AIR / BUS / TRAIN TERMINAL", "ATM SEPARATE FROM BANK",
      "SCHOOL - COLLEGE / UNIVERSITY") ~ "12A Personal Robbery",
    (NIBRS_CODE == "120" | str_detect(UOR_DESC, "\\bROBBERY\\b")) & 
      PREMISE_TYPE == "OTHER / UNKNOWN" ~ 
      "12U Other Robbery",
    (NIBRS_CODE == "120" | str_detect(UOR_DESC, "\\bROBBERY\\b")) ~ 
      "12B Commercial Robbery",
    
    # Assault offences
    # Some assault offences are listed under NIBRS_CODE 999, so must be
    # categorised according to the degree of assault.
    str_detect(UOR_DESC, "ASSAULT.+?(1ST|2ND)") == TRUE | UOR_DESC %in% c(
      "CRIMINAL ABUSE-1ST DEGREE", 
      "CRIMINAL ABUSE-1ST DEGREE-CHILD 12 OR UNDER", 
      "CRIMINAL ABUSE-3RD DEGREE", "MURDER - DOMESTIC VIOLENCE ATTEMPTED",
      "MURDER - POLICE OFFICER ATTEMPTED", "MURDER ATTEMPTED") ~ 
      "13A Aggravated assault",
    str_detect(UOR_DESC, "ASSAULT.+?(3RD|4TH)") == TRUE ~ "13B Simple assault",
    NIBRS_CODE == "999" & UOR_DESC %in% c("ABUSE OF A TEACHER PROHIBITED",
      "MENACING", "TERRORISTIC THREATENING 1ST DEGREE", 
      "TERRORISTIC THREATENING 2ND DEGREE", 
      "TERRORISTIC THREATENING 3RD DEGREE", 
      "INTIMIDATING A PARTICIPANT IN LEGAL PROCESS", 
      "HARASSMENT (NO PHYSICAL CONTACT)", 
      "HARASSMENT - PHYSICAL CONTACT - NO INJURY", "HARASSING COMMUNICATIONS",
      "RETALIATING AGAINST PARTICIPANT IN LEGAL PROCESS",
      "STALKING-1ST DEGREE", "STALKING-2ND DEGREE") ~
      "13C Intimidation",
    
    # burglary
    (NIBRS_CODE == "220" | str_detect(UOR_DESC, "\\bBURGLARY\\b") == TRUE) & 
      PREMISE_TYPE %in% c("RESIDENCE / HOME", 
      "PARKING LOT / GARAGE", "OTHER RESIDENCE (APARTMENT/CONDO)", 
      "ATTACHED RESIDENTIAL GARAGE", "PARKING LOT / GARAGE") ~ 
      "22A Residential Burglary/Breaking & Entering",
    (NIBRS_CODE == "220" | str_detect(UOR_DESC, "\\bBURGLARY\\b") == TRUE) ~ 
      "22B Non-residential Burglary/Breaking & Entering",
    
    # theft
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING/DISP-PURSESNATCHING  FELONY CLASS D") ~ 
      "23B Purse-snatching",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING/DISP-SHOPLIFTING - FELONY CLASS D",
      "THEFT BY UNLAWFUL TAKING/DISP-SHOPLIFTING -MISD") ~ "23C Shoplifting",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING/DISP - FROM BUILDING - MISD", 
      "THEFT BY UNLAWFUL TAKING/DISP-FROM BUILDING - $10,000 OR >",
      "THEFT BY UNLAWFUL TAKING/DISP-FROM BUILDING - FELONY D") ~ "23D Theft From Building",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING/DISP-CONTENTS FROM AUTO - FELONY", 
      "THEFT BY UNLAWFUL TAKING/DISP-CONTENTS FROM AUTO - MISD") ~ 
      "23F Theft From Motor Vehicle (except Theft of Motor Vehicle Parts or Accessories)",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAW TAKING/DISP-PARTS FROM VEHICLE $10,000 OR >",
      "THEFT BY UNLAWFUL TAKING/DISP-PARTS FROM VEHICLE - MISD",
      "THEFT OF MOTOR VEHICLE REGISTRATION PLATE/DECAL") ~ "23G Theft of Motor Vehicle Parts or Accessories",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING - GASOLINE - 1ST OFFENSE", 
      "THEFT BY UNLAWFUL TAKING - GASOLINE - U/$10,000", 
      "THEFT BY UNLAWFUL TAKING - GASOLINE - U/$500 MISD", 
      "THEFT BY UNLAWFUL TAKING-ALL OTHERS $10,000 OR MORE", 
      "THEFT BY UNLAWFUL TAKING/DISP-ALL OTHERS - FELONY CLASS D", 
      "THEFT BY UNLAWFUL TAKING/DISP-ALL OTHERS -MISD", "THEFT OF CARGO", 
      "THEFT OF CONTROLLED SUBSTANCE", 
      "THEFT OF CONTROLLED SUBSTANCE, 1ST OFFENSE OR UNDER $300", 
      "THEFT OF CONTROLLED SUBSTANCE, 2ND OR  > OFFENSE OR OVER $30", 
      "THEFT OF ID PRIOR TO JULY 2000", 
      "THEFT OF IDENTITY OF ANOTHER WITHOUT CONSENT", "THEFT OF MAIL MATTER", 
      "THEFT OF PROP LOST/MISLAID/DELIVERED BY MISTAKE FELONY D", 
      "THEFT OF PROPERTY LOST/MISLAID/DELIVERED BY MISTAKE MISD",
      "THEFT OF SERVICES - FELONY CLASS D", "THEFT OF SERVICES - MISD",
      "LESSER INCLUDED THEFT", "TBUT OR DISP FIREARM") ~ 
      "23H All Other Larceny",
    
    # motor vehicle theft
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "THEFT BY UNLAWFUL TAKING/DISP-AUTO - FELONY CLASS D",
      "THEFT BY UNLAWFUL TAKING/DISP-AUTO - MISD",
      "THEFT BY UNLAWFUL TAKING/DISP-AUTO $10,000 OR MORE") ~ 
      "240 Motor Vehicle Theft",
    
    # forgery
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "CRIMINAL POSS OF A FORGED PERSCRIPTION, 1ST OFFENSE",
      "CRIMINAL POSSESSION FORGED INSTRUMENT-1ST DEGREE-IDENTIFY",
      "CRIMINAL POSSESSION FORGED INSTRUMENT-2ND DEGREE-IDENTIFY",
      "CRIMINAL POSSESSION OF FORGED INSTRUMENT-3RD DEGREE",
      "FORGERY - 1ST DEGREE", "FORGERY - 2ND DEGREE", 
      "FORGERY OF A PRESCRIPTION - 1ST OFFENSE", "FORGERY-3RD DEGREE",
      "POSSESSION OF FORGED PRESCRIPTION FOR LEGEND DRUG 1ST",
      "UTTER FALSE/FORGED PRESCRIPTION", 
      "FALSE MAKING/EMBOSSING OF CREDIT CARD", 
      "POSSESSION OF A FORGERY DEVICE-IDENTIFY",
      "PROHIBIT COMMERCE COUNTERFEIT GOODS/SERVICES >25 ITMS 1ST OF") ~ 
      "250 Counterfeiting/Forgery",
    
    # fraud
    NIBRS_CODE == "999" & (str_detect(UOR_DESC, "\\bFRAUD.+?\\bCARD") == TRUE |
      UOR_DESC %in% c("MISUSE OF ELECTRONIC INFO-AUTOMATED BANKING DEVICE, ETC",
      "RECEIPT OF CREDIT CARD IN VIOLATION KRS 434.570, 434.610")) ~
      "26B Credit Card/Automated Teller Machine Fraud",
    NIBRS_CODE == "999" & UOR_DESC %in% c("IMPERSONATING A PEACE OFFICER") ~
      "26C Impersonation",
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "UNLAWFUL ACCESS TO COMPUTER-1ST DEGREE") ~ "26E Wire Fraud",
  
    # criminal damage
    NIBRS_CODE == "999" & UOR_DESC %in% c("CRIMINAL MISCHIEF - 1ST DEGREE",
      "CRIMINAL MISCHIEF-2ND DEGREE", "CRIMINAL MISCHIEF-3RD DEGREE",
      "CRIMINAL USE OF NOXIOUS SUBSTANCE") ~ 
      "290 Destruction/Damage/Vandalism of Property (except Arson)",
      
    # Drugs
    # There are lots of drug offences listed under NIBRS_CODE 999 (which does
    # not exist) and for which UOR_DESC involves variations on the phrase
    # possession of a controlled substance (typically abbreivated)
    str_detect(UOR_DESC, "\\bPOS.+?\\bCON.+?\\bSUB") == TRUE | 
      str_detect(UOR_DESC, "\\bTRAF.+?\\bCON.+?\\bSUB") == TRUE | 
      str_detect(UOR_DESC, "\\bTRF.+?\\bCON.+?\\bSUB") == TRUE |
      str_detect(UOR_DESC, "\\bTRAF.+?\\bMARIJUANA") == TRUE |
      (NIBRS_CODE == "999" & UOR_DESC %in% c(
        "ASSUME FALSE TITLE TO OBTAIN CONT SUB-1ST OFFENSE",
        "ATT/OBTAIN CONTSUB BY FRAUD/FLS STMT/FORGERY",
        "ATTEMPT/OBTAIN CONT SUB BY FRAUD/FALSE STMT/FORGERY-1ST OFF",
        "CULTIVATE IN MARIJUANA-< 5 PLANTS-1ST OFFENSE",
        "CULTIVATE IN MARIJUANA-< 5 PLANTS-2ND OR > OFFENSE",
        "CULTIVATE IN MARIJUANA-5 PLANTS OR >-1ST OFFENSE",
        "CULTIVATE IN MARIJUANA-5 PLANTS OR >-2ND OR > OFFENSE",
        "MANUFACTURING METHAMPHETAMINE 1ST OFFENSE",
        "MANUFACTURING METHAMPHETAMINE 2ND OR > OFFENSE",
        "POSS OF MARIJUANA", 
        "PRESCRIPTION CONT SUB NOT IN ORIGINAL CONTAINER-1ST OFFENSE",
        "UNLAWFUL DISTRIBUTION OF A METH PRECURSOR - 1ST OFFENSE",
        "UNLAWFUL DISTRIBUTION OF A METH PRECURSOR - 2ND OR > OFFENSE",
        "UNLAWFUL POSSESSION OF METH PRECURSOR 1ST OFFENSE",
        "UNLAWFUL POSSESSION OF METH PRECURSOR 2ND OR > OFFENSE",
        "TRAF IN SYNTHETIC CANNABINOIL AGOINTS OR PIPEAZINES",
        "TRAFFICKING IN A LEGEND DRUG, 1ST OFFENSE", "TRAFFICKING IN SALVIA",
        "ILLEGAL POSSESSION OF A LEGEND DRUG 1ST OFFENSE", 
        "ILLEGAL POSSESSION OF LEGEND DRUG", "POSSESSION OF SALVIA",
        "POSSESSION OF SYNTHETIC CANNABINOID AGONISTS OR PIPEAZINES",
        "SELL CONTROL SUBSTANCE TO A MINOR-1ST OFFENSE",
        "VOLATILE SUBSTANCE ABUSE")) ~ 
      "35A Drug/Narcotic Violations",
    NIBRS_CODE == "999" & UOR_DESC %in% c("DRUG PARAPHERNALIA - BUY/POSSESS",
      "DRUG PARAPHERNALIA-BUY/POSSESS-1ST OFFENSE", 
      "DRUG PARAPHERNALIA-BUY/POSSESS-2ND OR > OFFENSE") ~ 
      "35B Drug Equipment Violations",
    
    # non-violent sex offences
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "INCEST - VICTIM U/12 YOA OR SERIOUS PHYSICAL INJURY") ~ "36A Incest",
    
    # stolen property
    NIBRS_CODE == "999" & (str_detect(UOR_DESC, "STOLEN.+?PROPERTY") == TRUE |
      UOR_DESC %in% c("THEFT-RECEIPT OF STOLEN CREDIT/DEBIT CARD-1 CARD",
      "THEFT-RECEIPT OF STOLEN CREDIT/DEBIT CARD-2 OR MORE CARDS",
      "TRAFFICKING IN STOLEN IDENTITIES", 
      "OBSCURING THE IDENTITY OF A MACHINE U/$10000",
      "OBSCURING THE IDENTITY OF A MACHINE U/$500")) ~ 
      "280 Stolen Property Offenses",
    
    # obscene material
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "DIST OF MATTER PORTRAYING SEXUAL PERFORM BY MINOR 2ND > OFF",
      "POSSESSION OF MATTER PORTRAYING SEX PERFORMANCE BY MINOR") ~ 
      "370 Pornography/Obscene Material",
    
    # gambling
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "POSSESS OF GAMBLING RECORD-1ST DEGREE", 
      "POSSESSION OF A GAMBLING DEVICE") ~ "39C Gambling Equipment Violations",
    NIBRS_CODE == "999" & UOR_DESC %in% c("PROMOTING GAMBLING - 2ND DEGREE") ~
      "39B Operating/Promoting/Assisting Gambling",
    
    # prostitution
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "LOITERING FOR PROSTITUTION PURPOSES - 1ST OFFENSE",
      "LOITERING FOR PROSTITUTION PURPOSES - 2ND > OFFENSE", "PROSTITUTION") ~ 
      "40A Prostitution",
    
    # weapons violations
    NIBRS_CODE == "999" & UOR_DESC %in% c("CARRYING A CONCEALED DEADLY WEAPON",
      "DEFACING A FIREARM", "POSSESSION OF DEFACED FIREARM", 
      "POSSESSION OF FIREARM BY CONVICTED FELON", 
      "POSSESSION OF HANDGUN BY CONVICTED FELON",
      "UNLAWFUL POSSESSION OF WEAPON ON SCHOOL PROPERTY",
      "UNLAWFULLY PROV/PERMIT MINOR TO POSSESS HANDGUN",
      "USING RESTRICTED AMMO DURING A FELONY (NO SHOTS)", 
      "POSS HANDGUN BY MINOR 1ST OFFENSE", 
      "POSS,MANUF,TRANSPRT HANDGUN WITH EXC FOR UNLAWFUL",
      "POSS,MANUF,TRANSPRT HANDGUN WITH EXC FOR UNLAWFUL 2ND OFFENS") ~ 
      "520 Weapon Law Violations",
    
    # bad checks
    NIBRS_CODE == "999" & UOR_DESC %in% c("THEFT BY DECEPTION-INCL COLD CHECKS",
      "THEFT BY DECEPTION-INCL COLD CHECKS $10,000 OR MORE",
      "THEFT BY DECEPTION-INCL COLD CHECKS U/$10,000",
      "THEFT BY DECEPTION-INCL COLD CHECKS U/$500") ~ 
      "90A Bad Checks (except Counterfeit Checks or Forged Checks)",
    
    # loitering
    NIBRS_CODE == "999" & UOR_DESC %in% c("JUVENILE CURFEW ORD 17 & UNDER") ~ 
      "90B Curfew/Loitering/Vagrancy Violations",
    
    # Disorderly conduct
    UOR_DESC %in% c('INDECENT EXPOSURE - 1ST DEGREE - 1ST OFFENSE',
      'INDECENT EXPOSURE - 1ST DEGREE - 2ND OFFENSE', 
      'INDECENT EXPOSURE - 1ST DEGREE - 3RD OFFENSE', 
      'INDECENT EXPOSURE - 1ST DEGREE - 4TH OR > OFFENSE', 
      'INDECENT EXPOSURE - 2ND DEGREE') ~ '90C Disorderly Conduct',
    
    # Child abuse (non-violent)
    NIBRS_CODE == "999" & UOR_DESC %in% c(
      "CONTROLLED SUBSTANCE ENDANGERMENT TO CHILD 2ND DEGREE",
      "CONTROLLED SUBSTANCE ENDANGERMENT TO CHILD 4TH DEGREE") ~ 
      "90F Family Offenses, Nonviolent",
    
    # trespass
    NIBRS_CODE == "999" & UOR_DESC %in% c("CRIMINAL TRESPASSING-3RD DEGREE") ~ 
      "90J Trespass of Real Property",
    
    # All other offences
    UOR_DESC %in% c("ANY FELONY CATEGORY NOT LISTED", 
      "ADVERTISING MATTER PORTRAY SEX PERFORMANCE BY MINOR 1ST OFF",
      "CONTEMPT OF COURT - VIOL EMERGENCY PROTECTIVE ORDER",
      "CRUELTY TO ANIMALS - 2ND DEGREE", "DANGEROUS ANIMAL",
      "DANGEROUS DOG-CONTROL OF DOG", "DISARMING A PEACE OFFICER",
      "FAILURE TO COMPLY W/SEX OFFENDER REGISTRATION - 1ST OFF",
      "FLEEING OR EVADING POLICE - 1ST DEGREE (MOTOR VEHICLE)",
      "FLEEING OR EVADING POLICE - 1ST DEGREE (ON FOOT)",
      "FLEEING OR EVADING POLICE - 2ND DEGREE (MOTOR VEHICLE)",
      "ILLEGAL DUMPING LOUISVILLE METRO ORDINANCE",
      "LEAVING SCENE OF ACCIDENT - HIT & RUN",
      "LEAVING SCENE OF ACCIDENT/FAILURE TO RENDER AID OR ASSISTANC",
      "OBSTRUCTING GOVERNMENTAL OPERATIONS",
      "WANTON ENDANGERMENT-1ST DEGREE", 
      "WANTON ENDANGERMENT-1ST DEGREE-POLICE OFFICER", 
      "WANTON ENDANGERMENT-2ND DEGREE",
      "WANTON ENDANGERMENT-2ND DEGREE-POLICE OFFICER",
      "VIOLATING GRAVES", "VIOLATION UNKNOWN", 
      "WANTON ABUSE/NEGLECT OF ADULT BY PERON", 
      "INTERFERE W/ENFORCEMENT PROHI", "INTERMEDIATE LICENSING VIOLATIONS",
      "LICENSEE PERMIT NUDE PERFORMA", "OFFENSES AGAINST PUBLIC PEACE",
      "OWNER TO CONTROL ANIMAL", "PROBATION VIOLATION (FOR FELONY OFFENSE)",
      "PROBATION VIOLATION (FOR MISDEMEANOR OFFENSE)", 
      "PROBATION VIOLATION (JUVENILE PUBLIC OFFENSE)",
      "VIOLATION OF KENTUCKY EPO/DVO") ~ 
      "90Z All Other Offenses",
    
    # Non-categorisable offences
    UOR_DESC %in% c("DOMESTIC VIOLENCE INVOLVED INCIDENT") ~ 
      "99X Non-Categorisable Offenses",
    
    # Non-reportable crimes
    UOR_DESC %in% c('DISPLAY OF ILLEGAL/ALTERED REGISTRATION PLATE',
      'FAIL OF NON-OWNER/OPER TO MAINTAIN REQ INS/SECURITY 1ST OFF',
      'FAIL OF TRANSFEREE OF VEH TO PROMPTLY APPLY FOR NEW TITLE',
      'FAILURE OF OWNER TO MAINTAIN REQUIRED INS/SECURITY 1ST OFF',
      'FAILURE OF OWNER TO MAINTAIN REQUIRED INS/SECURITY 2ND OFF',
      'FAILURE OF SELLER TO DELIVER REGISTRATION W/ASSIGNMENT FORM',
      'IMPROPER EMERGENCY/SAFETY LIGHTS',
      'LEAV SCENE OF ACCIDENT/FAIL TO RNDR AID/ASSIST W/DEATH OR SJ',
      'MOTOR VEH DEALER REQ TO GIVE TITLE TO PURCHASER',
      'MOTOR VEHICLE DEALER LICENSE REQUIRED',
      'POSSESSING LICENSE WHEN PRIVILEGES ARE REVOKED', 
      "OPERATING ON SUSPENDED/REVOKED OPERATORS LICENSE", "RECKLESS DRIVING",
      "FAILURE TO OR IMPROPER SIGNAL", "NO OR EXPIRED REGISTRATION PLATES",
      "NO OPERATORS/MOPED LICENSE", "FAILURE TO WEAR SEAT BELTS",
      "FAILURE TO REGISTER TRANSFER OF MOTOR VEHICLE", 
      "FAILURE TO NOTIFY ADDRESS CHANGE TO DEPT OF TRANSPORTATION",
      "DISREGARDING STOP SIGN", "REAR LICENSE NOT ILLUMINATED",
      "DISREGARDING TRAFFIC CONTROL DEVICE, TRAFFIC LIGHT", "CARELESS DRIVING",
      "EXCESSIVE WINDSHIELD/ WINDOW TINTING", "FAILURE TO ILLUMINATE HEAD LAMPS",
      "IMPROPER DISPLAY OF REGISTRATION PLATES", "NO CARRIER PERMIT",
      "FAIL OF TRANSFEROR OF VEH TO PROP EXECUTE TITLE",
      "FAILURE TO NOTIFY OWNER OF DAMAGE TO UNATTENDED VEHICLE",
      "UNAUTHORIZED USE OF VEHICLE UNDER HARDSHIP DRIVERS LICENSE",
      "FAILURE TO PRODUCE INSURANCE CARD", "IMPROPER REGISTRATION PLATE",
      "HITCHHIKING/DISREGARDING TRAFFIC REGULATIONS BY PEDESTRIAN",
      "IMPROPER TURNING", "OBSTRUCTED VISION AND/OR WINDSHIELD",
      "ONE HEADLIGHT", "OPERATING VEHICLE WITH EXPIRED OPERATORS LICENSE",
      "SPEEDING 15 MPH OVER LIMIT", "ABANDONMENT OF VEHICLE ON PUBLIC ROAD",
      "LOCAL VIOLATION CODES 80000 - 80999", "SPEEDING - SPEED NO SPECIFIED",
      "SPEEDING 12 MPH OVER LIMIT", "SPEEDING 14 MPH OVER LIMIT",
      "SPEEDING 20 MPH OVER LIMIT", "SPEEDING 26 MPH OR GREATER OVER LIMIT",
      "SPEEDING 7 MPH OVER LIMIT - LIMITED ACCESS HWY",
      "DISPLAY/POSSESSOIN OF CANCELLED/FICTITIOUS OPERATOR LICENSE",
      "DRIVING TOO FAST FOR TRAFFIC CONDITIONS", 
      "FAIL TO GIVE RT OF WY TO VESS APPR SHORELINE", 
      "FOLLOWING ANOTHER VEHICLE TOO CLOSELY",
      "FAILURE TO GIVE RIGHT OF WAY TO EMERGENCY VEHICLE",
      "FAILURE TO REPORT TRAFFIC ACCIDENT",
      "FAILURE TO USE CHILD RESTRAINT DEVICE IN VEHICLE",
      "IMPROPER SOUND DEVICE (WHISTLE, BELL, SIREN)",
      "IMPROPER STOPPING AT FLASHING RED LIGHT", "IMPROPER USE OF BLUE LIGHTS",
      "IMPROPER USE OF RED LIGHTS", "IMPROPERLY ON LEFT SIDE OF ROAD",
      "HITCHHIKING ON LIMITED ACCESS FACILITIES", 
      "INSTRUCTIONAL PERMIT VIOLATIONS", "LICENSE TO BE IN POSSESSION",
      "NO PERSON SHALL HAVE MORE THAN ONE OPERATORS LICENSE", 
      "NO REAR VIEW MIRROR", "NO/EXPIRED KENTUCKY REGISTRATION RECEIPT",
      "PERMIT UNLICENSED OPERATOR TO OPERATE MOTOR VEHICLE",
      "REPRESENTING AS ONES OWN ANOTHERS OPER LIC",
      "RIM OR FRAME OBSCURING LETTERING OR DECAL ON PLATE",
      "SEAT BELT ANCHORS,CHILD RESTRAINTS") ~ 
      '99Y Non-Reportable Crimes',
    
    # Non-criminal matters
    UOR_DESC %in% c('ACCIDENTAL DEATH (DROWNING)', 
      'ACCIDENTAL DEATH (OTHER THAN DROWNING AND HUNTING)',
      'ACCIDENTAL SHOOTING (OTHER THAN HUNTING)',
      'DOMESTIC ABUSE DUTIES OF LAW ENFORCEMENT',
      'EMERGENCY ADMIT,MENTAL HEALTH HOSP.-UNIFIED JUV CO',
      'EMERGENCY CUSTODY ORDERS UNIFIED JUVENILE CODE',
      'INVOLUN ADMIT MENTAL HEALTH HOSP - UNIFIED JUV CODE',
      'INVOLUNTARY HOSPITALIZATION OF MENTALLY ILL - 60/360 DAYS',
      'NON-CRIMINAL DEATH (NATURAL CAUSES)',
      'PROPERTY LOST OR ABANDONED NON CRIMINAL',
      'RECOVERY OF STOLEN PROPERTY',
      'SERVING BENCH WARRANT FOR COURT',
      'SERVING WARRANT (FOR OTHER POLICE AGENCY)', "SEE ACCIDENT MODULE", 
      "PRELIMINARY REPORT NUMBER", "REPORT NUMBER NOT REQUIRED", 
      "VOIDED REPORT NUMBER", "FINANCIAL CRIME/OUT OF JURISDICTION",
      "RECOVERY OF STOLEN VEHICLE-OUT OF JURISDICTION", 
      "NARC INVESTIGATION PENDING", "INJURED PERSON REQUIRING POLICE REPORT",
      "OVERDOSE", "CIT FORM COMPLETED", "SUICIDE", "UNSUBSTANTIATED RAPE",
      "CACU INVESTIGATION PENDING", "CACU UNSUBSTANTIATED CASES", 
      "SVU INVESTIGATION PENDING", "COLD CASE REPORT NUMBER", 
      "9TH MOBILE PENDING", "RUNAWAY (STATUS OFFENDERS-UNIFIED JUVENILE CODE)",
      "CACU ASSISTING OTHER AGENCY", "UNSUBSTANTIATED SODOMY",
      "SUSPICIOUS ACTIVITY/POSSIBLE ABDUCTOR", "JUSTIFIABLE HOMICIDE",
      "UNSUBSTANTIATED SEXUAL ABUSE", "DV WAITING ON CHARGE",
      "DEATH INVESTIGATION - LMPD INVOLVED",
      "DEATH INVESTIGATION - OTHER POLICE AGENCY INVOLVED",
      "SHOOTING INVESTIGATION - LMPD INVOLVED", 
      "SHOOTING INVESTIGATION - OTH POLICE AGENCY INVOLVED",
      "IN-CUSTODY DEATH - CORRECTIONS - IN FACILITY",
      "IN-CUSTODY DEATH - CORRECTIONS - NOT IN FACILITY",
      "IN-CUSTODY DEATH - OTHER POLICE AGENCY INVOLVED",
      "OFFICER NEEDS TO COMPLETE INCIDENT REPORT", 
      "(NO OFFENSE COUNT) BURGLARY 1A",
      "(NO OFFENSE COUNT) BURGLARY 2A", "(NO OFFENSE COUNT) BURGLARY 3A", 
      "ABANDONED ON PRIVATE PROPERTY",
      "ANY NON CRIMINAL CHARGE NOT COVERED BY THESE CODES", "MISC PENDING",
      "UNIDENTIFIED PERSON OR REMAINS", "CYBER CRIME PENDING",
      "SEX OFFENDER REGISTRANT, OUT-OF-STATE, MOVE TO KY",
      "SUICIDE INVESTIGATION (POLICE ON SCENE)", 
      "SUICIDE INVESTIGTION - CORRECTIONS - IN FACILITY", 
      "SUICIDE INVESTIGATION (IN POLICE CUSTODY -OTHER AGENCY)",
      "GARBAGE AND RUBBISH", "EMA INCIDENT", "FUGITIVE - WARRANT NOT REQUIRED",
      "FUGITIVE FROM ANOTHER STATE - WARRANT REQUIRED",
      "INJURED PERSON (LMPD INVOLVED)", "NARC UNSUBSTANTIATED CASES",
      "NCIC NOT NOTIFIED", "SEE KRS ENTRY") ~ 
      '99Z Non-Criminal Matters',
    
    # all other crimes keep their existing code
    TRUE ~ NIBRS_Offense_Type
      
  )) %>% 
  # Since we've changed NIBRS_Offense_Type for some offences it is necessary to
  # also change the higher-level NIBRS categories. To do this we can remove the
  # existing NIBRS fields and join them again from the NIBRS categories object.
  select(-NIBRS_Offense_Code, -NIBRS_Offense_Category, -NIBRS_Crime_Against) %>% 
  left_join(nibrs_categories, by = "NIBRS_Offense_Type") %>% 
  # mutate(
  #   NIBRS_Offense_Category = if_else(
  #     NIBRS_Offense_Type %in% c('99Y Non-Reportable Crimes', 
  #                               '99Z Non-Criminal Matters'), 
  #     'Excluded cases', NIBRS_Offense_Category),
  #   NIBRS_Crime_Against = if_else(
  #     NIBRS_Offense_Type %in% c('99Y Non-Reportable Crimes', 
  #                               '99Z Non-Criminal Matters'), 
  #     'Excluded cases', NIBRS_Crime_Against),
  #   NIBRS_Offense_Code = case_when(
  #   NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
  #   NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~ 
  #     "22B",
  #   NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
  #   NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
  #   NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
  #   TRUE ~ NIBRS_Offense_Code
  # )) %>% 
  check_nibrs_cats("../crime_categories/categories_Louisville", 
                   by = c("NIBRS_CODE", "CRIME_TYPE", "UOR_DESC")) %>% 
  # identify location types
  left_join(
    read_csv("../crime_categories/location_types_louisville.csv", 
             col_types = cols(.default = col_character())),
    by = "PREMISE_TYPE"
  ) %>% 
  save_city_data("Louisville") %>% 
  glimpse()
```


# New York

```{r}
read_csv('../original_data/New York 2006 to 2017.csv', 
         col_types = cols(
           .default = col_character(),
           CMPLNT_NUM = col_integer(),
           KY_CD = col_integer(),
           PD_CD = col_integer(),
           ADDR_PCT_CD = col_integer(),
           X_COORD_CD = col_integer(),
           Y_COORD_CD = col_integer(),
           Latitude = col_double(),
           Longitude = col_double()
         )
  ) %>% 
  report_status("File read") %>% 
  # since NYC includes both start and end dates, so we will process the dates
  # manually rather than using add_date_var()
  mutate(
    # Some early NYC offences have times equal to 24:00:00, which cannot be 
    # parsed by R date functions
    CMPLNT_FR_TM = if_else(CMPLNT_FR_TM == "24:00:00", "23:59:59", CMPLNT_FR_TM),
    CMPLNT_TO_TM = if_else(CMPLNT_TO_TM == "24:00:00", "23:59:59", CMPLNT_TO_TM),
    # For offences with only one date, there is some inconsistency in which date 
    # is included. In almost all cases the start date is the date provided, but 
    # occasionally only the end date is present. The next line copies the 
    # single date from the end date to the start date and (separtely) the single
    # time to end date to the start date.
    CMPLNT_FR_DT = ifelse(is.na(CMPLNT_FR_DT), CMPLNT_TO_DT, CMPLNT_FR_DT),
    CMPLNT_FR_TM = ifelse(is.na(CMPLNT_FR_TM), CMPLNT_TO_TM, CMPLNT_FR_TM),
    # For offences with a time but no date in either column, use the reported 
    # date as the start date
    CMPLNT_FR_DT = ifelse(is.na(CMPLNT_FR_DT) & !is.na(CMPLNT_FR_TM), RPT_DT, 
                          CMPLNT_FR_DT)
  ) %>% 
  report_status("Impossible times changed") %>% 
  # Now we can convert the date strings to date objects
  mutate(
    Date.Start.Temp = parse_date_time(paste(CMPLNT_FR_DT, CMPLNT_FR_TM), 'mdY T', 
                                      tz = 'America/New_York'),
    Date.End.Temp = parse_date_time(paste(CMPLNT_TO_DT, CMPLNT_TO_TM), 'mdY T', 
                                    tz = 'America/New_York'),
    Date.Temp = strftime(Date.Start.Temp + ((Date.End.Temp - Date.Start.Temp)/2), 
                         format = '%Y-%m-%d %H:%M', tz = 'America/New_York'),
    Date.Temp = ifelse(is.na(Date.Temp), 
                       strftime(Date.Start.Temp, format = "%Y-%m-%d %H:%M", 
                                tz = 'America/New_York'), 
                       Date.Temp),
    Date.Year = year(Date.Temp),
    Date.Start = strftime(Date.Start.Temp, format = '%Y-%m-%d %H:%M', 
                          tz = 'America/New_York'),
    Date.End = strftime(Date.End.Temp, format = '%Y-%m-%d %H:%M', 
                        tz = 'America/New_York'),
    Date.Single = strftime(Date.Temp, format = '%Y-%m-%d %H:%M', 
                           tz = 'America/New_York'),
    Multiple.Dates = TRUE
  ) %>% 
  select(-Date.Start.Temp, -Date.End.Temp, -Date.Temp) %>% 
  report_status("Strings converted to dates") %>% 
  {
    cat("  Failures:  Date.Start:", sum(is.na(.$Date.Start)), " Date.End:", 
        sum(is.na(.$Date.End)), " Date.Single:", sum(is.na(.$Date.Single)), 
        "\n")
    .
  } %>% 
  filter_by_year(2007, yearLast) %>% 
  report_status("Matching cases to NIBRS categories") %>% 
  join_nibrs_cats("../crime_categories/categories_NYC.csv",
                  by = c('OFNS_DESC', 'PD_DESC')) %>% 
  # left_join(read_csv("../crime_categories/categories_NYC.csv"), 
  #           by = c('OFNS_DESC', 'PD_DESC')) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    # burglary
    NIBRS_Offense_Code == "220" & PD_DESC %in% c("BURGLARY,RESIDENCE,DAY", 
      "BURGLARY,RESIDENCE,NIGHT", "BURGLARY,RESIDENCE,UNKNOWN TIM") ~ 
      "22A Residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ 
      "22B Non-residential Burglary/Breaking & Entering",
    
    # robbery
    NIBRS_Offense_Code == "120" & PD_DESC %in% c(
      "ROBBERY,PERSONAL ELECTRONIC DEVICE",
      "ROBBERY,OPEN AREA UNCLASSIFIED", "ROBBERY,RESIDENTIAL COMMON AREA",
      "ROBBERY,DWELLING", "ROBBERY,POCKETBOOK/CARRIED BAG", 
      "ROBBERY,BEGIN AS SHOPLIFTING", "ROBBERY,HOME INVASION", 
      "ROBBERY,NECKCHAIN/JEWELRY", "ROBBERY,PUBLIC PLACE INSIDE", 
      "ROBBERY,BICYCLE", "ROBBERY,CLOTHING", "ROBBERY,CAR JACKING", 
      "ROBBERY,ATM LOCATION") ~ "12A Personal Robbery",
    NIBRS_Offense_Code == "120" ~ "12B Commercial Robbery",
    
    # all other crimes
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  # identify location types
  left_join(
    read_csv("../crime_categories/location_types_new_york.csv", 
             col_types = cols(.default = col_character())),
    by = "PREM_TYP_DESC"
  ) %>% 
  save_city_data("New York") %>% 
  glimpse()
```


# San Francisco

San Francisco data don't include a location-type field.

```{r}
read_csv('../original_data/San Francisco 2003 to date.csv', col_types = cols(
  .default = col_character(),
  IncidntNum = col_integer(),
  X = col_double(),
  Y = col_double(),
  PdId = col_double()
)) %>% 
  rename(Longitude = X, Latitude = Y) %>% 
  mutate(Date = paste(Date, Time)) %>% 
  add_date_var("Date", "mdY R", "America/Los_Angeles") %>% 
  filter_by_year(yearFirst, yearLast) %>% 
  join_nibrs_cats("../crime_categories/categories_SF.csv",
                  by = c('Category', 'Descript')) %>% 
  # left_join(read_csv("../crime_categories/categories_SF.csv"), 
  #           by = c('Category', 'Descript')) %>% 
  mutate(NIBRS_Offense_Type = case_when(
    # burglary
    NIBRS_Offense_Code == "220" & Descript %in% c(
      "BURGLARY OF STORE, UNLAWFUL ENTRY", 
      "BURGLARY,STORE UNDER CONSTRUCTION, FORCIBLE ENTRY", 
      "BURGLARY,STORE UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY OF STORE, FORCIBLE ENTRY",
      "BURGLARY OF HOTEL ROOM, UNLAWFUL ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, FORCIBLE ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, UNLAWFUL ENTRY",
      "BURGLARY,STORE UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY OF STORE, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY OF WAREHOUSE, FORCIBLE ENTRY", 
      "BURGLARY OF WAREHOUSE, UNLAWFUL ENTRY",
      "BURGLARY OF HOTEL ROOM, FORCIBLE ENTRY", "SAFE BURGLARY OF A STORE", 
      "BURGLARY,APT UNDER CONSTRUCTION, UNLAWFUL ENTRY", "SAFE BURGLARY",
      "BURGLARY,APT UNDER CONSTRUCTION, FORCIBLE ENTRY", 
      "BURGLARY,FLAT UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,FLAT UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY,RESIDENCE UNDER CONSTRT, ATT. FORCIBLE",
      "BURGLARY OF WAREHOUSE, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY,BLDG. UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY,HOTEL UNDER CONSTRUCTION, UNLAWFUL ENTRY",
      "BURGLARY OF HOTEL ROOM, ATTEMPTED FORCIBLE ENTRY",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, FORCIBLE ENTRY",
      "BURGLARY,HOTEL UNDER CONSTRUCTION, FORCIBLE ENTRY",
      "BURGLARY,APT UNDER CONSTRUCTION, ATT. FORCIBLE", 
      "SAFE BURGLARY OF A HOTEL", "SAFE BURGLARY OF A WAREHOUSE",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, UNLAWFUL ENTRY",
      "BURGLARY,FLAT UNDER CONSTRUCTION, ATT. FORCIBLE",
      "BURGLARY,WAREHOUSE UNDER CONSTRT, ATT. FORCIBLE",
      "SAFE BURGLARY OF A WAREHOUSE WITH EXPLOSIVES",
      "SAFE BURGLARY WITH EXPLOSIVES", 
      "BURGLARY,HOTEL UNDER CONSTRUCTION, ATT. FORCIBLE") ~ 
      "22B Non-residential Burglary/Breaking & Entering",
    NIBRS_Offense_Code == "220" ~ "22A Residential Burglary/Breaking & Entering",
    
    # robbery
    NIBRS_Offense_Code == "120" & Descript %in% c(
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT, STRONGARM", 
      "ROBBERY OF A CHAIN STORE WITH BODILY FORCE", 
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT WITH A GUN", 
      "ROBBERY OF A CHAIN STORE WITH A GUN",
      "ROBBERY OF A BANK WITH BODILY FORCE", "ROBBERY OF A BANK WITH A GUN", 
      "SHOPLIFTING, FORCE AGAINST AGENT", 
      "ROBBERY OF A CHAIN STORE WITH A DANGEROUS WEAPON",
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT W/ A KNIFE",
      "ROBBERY OF A SERVICE STATION WITH A GUN",
      "ROBBERY OF A BANK WITH A DANGEROUS WEAPON", 
      "ATTEMPTED ROBBERY COMM. ESTAB. WITH BODILY FORCE",
      "ROBBERY OF A CHAIN STORE WITH A KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH BODILY FORCE",
      "ROBBERY OF A COMMERCIAL ESTABLISHMENT W/ WEAPON",
      "ATTEMPTED ROBBERY COMM. ESTABLISHMENT WITH A GUN",
      "ATTEMPTED ROBBERY COMM. ESTAB. WITH DEADLY WEAPON",
      "ROBBERY OF A SERVICE STATION WITH BODILY FORCE",
      "ATTEMPTED ROBBERY OF A BANK WITH BODILY FORCE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH A GUN",
      "ATTEMPTED ROBBERY OF A BANK WITH A DEADLY WEAPON",
      "ATTEMPTED ROBBERY COMM. ESTABLISHMENT W/KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH DEADLY WEAPON",
      "ATTEMPTED ROBBERY OF A BANK WITH A GUN",
      "ROBBERY OF A SERVICE STATION W/DANGEROUS WEAPON",
      "ROBBERY OF A SERVICE STATION WITH A KNIFE",
      "ATTEMPTED ROBBERY CHAIN STORE WITH A KNIFE",
      "ATTEMPTED ROBBERY SERVICE STATION WITH A GUN",
      "ATTEMPTED ROBBERY SERVICE STATION W/BODILY FORCE",
      "ROBBERY OF A BANK WITH A KNIFE", 
      "ATTEMPTED ROBBERY OF A BANK WITH A KNIFE", 
      "ATTEMPTED ROBBERY SERVICE STATION WITH A KNIFE",
      "ATTEMPTED ROBBERY SERVICE STATION W/DEADLY WEAPON",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ FORCE",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ GUN",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ OTHER WEAPON",
      "ASSAULT TO ROB BANK WITH A GUN",
      "ROBBERY, VEHICLE FOR HIRE, ATT., W/ KNIFE") ~ "12B Commercial Robbery",
    NIBRS_Offense_Code == "120" ~ "12A Personal Robbery",
    
    # all other crimes
    TRUE ~ NIBRS_Offense_Type
  ),
  # where necessary, update the NIBRS code to match the new type
  NIBRS_Offense_Code = case_when(
    NIBRS_Offense_Type == "22A Residential Burglary/Breaking & Entering" ~ "22A",
    NIBRS_Offense_Type == "22B Non-residential Burglary/Breaking & Entering" ~ 
      "22B",
    NIBRS_Offense_Type == "12A Personal Robbery" ~ "12A",
    NIBRS_Offense_Type == "12B Commercial Robbery" ~ "12B",
    NIBRS_Offense_Type == "12U Other Robbery" ~ "12U",
    TRUE ~ NIBRS_Offense_Code
  )) %>% 
  save_city_data("San Francisco") %>% 
  glimpse()
```


# Seattle

Data are from https://data.seattle.gov/Public-Safety/Seattle-Police-Department-Police-Report-Incident/7ais-f98f

```{r}
# %m/%d/%Y %I:%M:%S %p
read_csv("../original_data/Seattle 2008 to date.csv", col_types = cols(
  .default = col_character(),
  `RMS CDW ID` = col_integer(),
  `General Offense Number` = col_integer(),
  `Offense Code Extension` = col_integer(),
  Longitude = col_double(),
  Latitude = col_double(),
  Month = col_integer(),
  Year = col_integer()
)) %>% 
  # since Seattle includes both start and end dates, so we will process the 
  # dates manually rather than using add_date_var()
  mutate(
    Date.Start.Temp = parse_date_time(`Occurred Date or Date Range Start`, 
                                      "mdY T", tz = "America/Los_Angeles"),
    Date.End.Temp = parse_date_time(`Occurred Date Range End`, "mdY T", 
                                    tz = "America/Los_Angeles"),
    Date.Temp = strftime(Date.Start.Temp + ((Date.End.Temp - Date.Start.Temp)/2), 
                         format = '%Y-%m-%d %H:%M', tz = "America/Los_Angeles"),
    Date.Year = year(Date.End.Temp),
    Date.Start = strftime(Date.Start.Temp, format = '%Y-%m-%d %H:%M', 
                          tz = "America/Los_Angeles"),
    Date.End = strftime(Date.End.Temp, format = '%Y-%m-%d %H:%M', 
                        tz = "America/Los_Angeles"),
    Date.Single = strftime(Date.Temp, format = '%Y-%m-%d %H:%M', 
                           tz = "America/Los_Angeles"),
    Multiple.Dates = TRUE
  ) %>% select(-Date.Start.Temp, -Date.End.Temp, -Date.Temp) %>% 
  # filter by year
  filter_by_year(2008, yearLast) %>% 
  # add crime categories
  join_nibrs_cats("../crime_categories/categories_Seattle.csv",
                  by = c("Summarized Offense Description", "Offense Type")) %>% 
  # left_join(read_csv("../crime_categories/categories_Seattle.csv"), 
  #           by = c("Summarized Offense Description", "Offense Type")) %>% 
  # save data
  save_city_data("Seattle") %>% 
  glimpse()
```


# Tucson

Data are from http://gisdata.tucsonaz.gov/datasets?group_ids=b6a49faa168647d8b56e1a06bd53600f&page=2&sort=name&t=police in invidiual files for each year from 2009. The variable names are
not consistent across years, so some adjustment is required before rows are
bound together. Columns are in a different order in some files, so `row_bind()`
is used to bind by column names.

The 2016 CSV file does not include co-ordinates, so first we must convert the
alternative shapefile format available on the website to the same CSV format as
the other files.

Tucson data don't include a location-type field.

```{r}
# Specifying GEOMETRY=AS_XY here creates two columns in the output CSV file
# named X and Y, which conveniently is the name for the co-ordinate columns in
# the CSV files from other years. To avoid duplicate column names, we first
# remove the existing X and Y columns, which in any case are empty.
st_read("../original_data/Incidents_2016__Tucson_Police_Department.shp") %>% 
  select(-X, -Y) %>% 
  st_write("../original_data/Tucson 2016.csv", 
           layer_options = "GEOMETRY=AS_XY")
```

It seems to take some time for Tuscon to post annual files, but there is also a
current Incidents file that covers the past 18 months. We can use this to get
data for 2017, but must first filter out data that would otherwise duplicate
records held in the 2016 file.

```{r}
read_csv("../original_data/Incidents__Tucson_Police_Department.csv") %>% 
  filter(year(DATE_OCCU) == 2017) %>% 
  arrange(DATE_OCCU) %>% 
  write_csv("../original_data/Tucson 2017.csv", na = "")
```


```{r}
dir(path = "../original_data", pattern = '^Tucson*', 
    full.names = TRUE) %>% 
  map(function (x) {
    
    # there are several differences between the formats of the Tucson data from
    # different years, which must be harmonised before the data can be joined
    
    # read data
    y <- read_csv(x, col_types = cols(.default = col_character())) %>% 
      rename(Longitude = X, Latitude = Y) %>% 
      mutate_at(vars(c("Longitude", "Latitude")), as.numeric)
    
    # harmonise inconsistently named variables
    if ("ADDRRESS_PUBLIC" %in% names(y)) {
      y <- y %>% rename(ADDRESS_PUBLIC = ADDRRESS_PUBLIC)
    } else if ("ADDRESS_PU" %in% names(y)) {
      y <- y %>% rename(ADDRESS_PUBLIC = ADDRESS_PU)
    }
    if ("WEAPON1DES" %in% names(y)) {
      y <- y %>% rename(WEAPON1DESC = WEAPON1DES)
    }
    
    # Transform co-ordinates if not in WGS84 (i.e. if the co-ordinates are so
    # much larger than is possible for Lat/Lon pairs that it can't be due to
    # rounding errors or similar). This code creates an SF object from the
    # existing tibble, transforms it, extracts the transformed co-ordinates and
    # converts the SF object back to a tibble. The custom CRS is taken from the
    # shapefile used to obtain the 2016 data (see above).
    if (max(y$Longitude, na.rm = TRUE) > 180*2) {
      y <- y %>% 
        # sf_as_sf() doesn't allow missing values, so we must first remove any
        # rows that don't have co-ordinates
        filter(!is.na(Longitude) & !is.na(Latitude)) %>% 
        st_as_sf(coords = c("Longitude", "Latitude"), 
        crs = "+proj=tmerc +lat_0=31 +lon_0=-111.9166666666667 +k=0.9999 +x_0=213360 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=ft +no_defs") %>% 
        st_transform(4326) %>% 
        mutate(
          Longitude = sapply(st_geometry(.), function (x) x[[1]]), 
          Latitude = sapply(st_geometry(.), function (x) x[[2]])
        ) %>% 
        st_set_geometry(NULL)
    }
    
    # return data
    y
    
  }) %>% 
  bind_rows() %>%
  # The field STATUTDESC has triple quotes around it in the CSV file, only two
  # pairs of which are removed by read_csv, so the remainder are removed here
  mutate(
    STATUTDESC = str_remove_all(STATUTDESC, "\""),
    date_occurred = paste(parse_date(DATE_OCCU, format = "%Y-%m-%d%.%H:%M:%S%+"), 
                      HOUR_OCCU)
  ) %>%
  add_date_var("date_occurred", "Ymd HM", "America/Phoenix") %>%
  # Since we added a variable holding the combined date and time as a string, we 
  # will remove it again to avoid keeping unnecessary variables.
  select(-date_occurred) %>% 
  filter_by_year(2009, yearLast) %>% 
  # A few crimes have no offence category listed. We will remove these now to
  # make joining the NIBRS variables easier. This also removes the large number
  # of cases in the 2017 file that do not relate to crime (e.g. traffic stops)
  # and for which the STATUTDESC field is set to the string 'N/A'
  filter(!is.na(STATUTDESC) & STATUTDESC != "N/A") %>% 
  # join NIBRS categories
  join_nibrs_cats("../crime_categories/categories_Tucson.csv",
                  by = 'STATUTDESC') %>% 
  # left_join(read_csv("../crime_categories/categories_Tucson.csv"), 
  #           by = 'STATUTDESC') %>% 
  save_city_data("Tucson") %>% 
  glimpse()
```


# Virginia Beach

Data are from https://data.vbgov.com/Public-Safety/Police-Incident-Reports/iqkq-gr5p

Virginia Beach data don't include a location-type field.

```{r}
list(
  read_csv("../original_data/Virginia Beach (early).csv") %>% 
    mutate(year = year(parse_date_time(`Date Occured`, "mdY T", 
                                       tz = "America/New_York"))) %>% 
    filter(year < 2016),
  read_csv("../original_data/Virginia Beach (recent).csv") %>% 
    mutate(year = year(parse_date_time(`Date Occured`, "mdY T", 
                                       tz = "America/New_York"))) %>% 
    filter(year >= 2016)
) %>% 
  bind_rows() %>% 
# read_csv("../original_data/Virginia Beach time period to be checked.csv") %>% 
  mutate(
    Address = str_replace_all(Location, "\\n", " ") %>% trimws(),
    Location = str_extract(Location, "\\(.+?\\)$") %>% 
      str_replace("\\((.+?)\\)", "\\1")
  ) %>%
  separate(Location, c("Latitude", "Longitude"), ", ") %>%
  mutate_at(vars(c("Latitude", "Longitude")), as.double) %>%
  add_date_var("Date Occured", "mdY T", "America/New_York") %>%
  filter_by_year(2013, yearLast) %>% 
  join_nibrs_cats("../crime_categories/categories_VB.csv",
                  by = 'Offense Code') %>% 
  # left_join(read_csv("../crime_categories/categories_VB.csv"), 
  #           by = 'Offense Code') %>% 
  save_city_data("Virginia Beach") %>% 
  glimpse()
```



